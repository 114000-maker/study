<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒ å¥ˆç±³å¤§é¦™è•‰ å°ˆæ¥­äººåƒä¿®åœ–&è²¼åœ– V5.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #0f0c29;
            background-image: linear-gradient(to right top, #0c0a1e, #1d1948, #3c2378, #6627aa, #9a25db);
            min-height: 100vh;
            font-family: 'Microsoft JhengHei', 'PingFang TC', 'Noto Sans CJK TC', sans-serif;
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .option-card, .reaction-btn, .variation-btn, .theme-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .option-card:hover, .reaction-btn:hover, .variation-btn:hover, .theme-card:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.2);
        }
        .option-card.selected, .reaction-btn.selected, .variation-btn.selected, .mode-btn.selected, .theme-card.selected {
            background: rgba(88, 80, 236, 0.5);
            border-color: #5850ec;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(88, 80, 236, 0.2);
        }
        .preview-container {
            max-height: 400px;
            overflow: hidden;
            border-radius: 12px;
        }
        .preview-image {
            width: 100%;
            height: auto;
            object-fit: cover;
        }
        .processing {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.05); }
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(34, 197, 94, 0.9);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
            z-index: 1000;
            transform: translateX(120%);
            transition: transform 0.3s ease-in-out;
        }
        .notification.show {
            transform: translateX(0);
        }
        .notification.error {
            background: rgba(239, 68, 68, 0.9);
        }
        .upload-zone {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
        .upload-zone.dragover {
            border-color: #5850ec;
            background-color: rgba(88, 80, 236, 0.1);
        }
        .result-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        .result-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        /* Toggle Switch Styles */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.2);
            transition: .4s;
            border-radius: 28px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: #f59e0b; /* yellow-500 */
        }
        input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }
    </style>
</head>
<body class="text-white">
    <!-- Notifications -->
    <div id="notification" class="notification"></div>

    <div class="min-h-screen p-4 sm:p-6 md:p-8">
        <!-- Header -->
        <div class="text-center mb-8 max-w-3xl mx-auto">
            <h1 class="text-2xl sm:text-3xl md:text-4xl lg:text-5xl font-bold text-white mb-2 whitespace-nowrap">
                ğŸŒ å¥ˆç±³å¤§é¦™è•‰ å°ˆæ¥­äººåƒä¿®åœ–&è²¼åœ– V5.0
            </h1>
            <p class="text-white opacity-80">
                3Aç§‘æŠ€å¯¦é©—å®¤
            </p>
        </div>

        <!-- Mode Switcher -->
        <div class="flex justify-center flex-wrap gap-4 mb-8">
            <button id="mode-btn-portrait" class="mode-btn selected px-6 py-3 rounded-lg font-semibold transition-all">
                ğŸ¨ å°ˆæ¥­äººåƒä¿®åœ–
            </button>
            <button id="mode-btn-sticker" class="mode-btn px-6 py-3 rounded-lg font-semibold transition-all bg-white bg-opacity-10 hover:bg-opacity-20">
                âœ¨ AI è²¼åœ–è£½ä½œ
            </button>
             <button id="mode-btn-photo" class="mode-btn px-6 py-3 rounded-lg font-semibold transition-all bg-white bg-opacity-10 hover:bg-opacity-20">
                ğŸ­ äººçš®è§£æ†‚è™Ÿ
            </button>
        </div>

        <!-- Main Content Area -->
        <div class="max-w-7xl mx-auto">
            <!-- Portrait Mode -->
            <div id="portrait-mode">
                <div class="grid lg:grid-cols-3 gap-8">
                    <!-- Left: Upload & Variations -->
                    <div class="lg:col-span-1 space-y-6">
                        <div class="glass-effect rounded-2xl p-6 space-y-6">
                           <div>
                               <h3 class="text-lg font-semibold text-white mb-4">è™•ç†æ¨¡å¼</h3>
                               <div class="grid grid-cols-2 gap-3">
                                   <button id="portrait-mode-single" class="p-3 rounded-lg text-sm font-medium transition-all bg-blue-500 text-white">å–®å¼µè™•ç†</button>
                                   <button id="portrait-mode-batch" class="p-3 rounded-lg text-sm font-medium transition-all bg-white bg-opacity-20 text-white hover:bg-opacity-30">æ‰¹é‡è™•ç†</button>
                               </div>
                           </div>
                           <div>
                                <h3 class="text-lg font-semibold text-white mb-4">ä¸Šå‚³ç…§ç‰‡</h3>
                                <div class="upload-zone rounded-lg p-6 text-center" id="upload-zone-portrait">
                                    <input type="file" id="file-input-portrait" accept="image/*" multiple class="hidden"/>
                                    <div class="text-4xl mb-3">ğŸ“·</div>
                                    <p class="text-white mb-2">æ‹–æ‹½ç…§ç‰‡åˆ°é€™è£¡æˆ–é»æ“Šä¸Šå‚³</p>
                                    <button id="upload-btn-portrait" class="px-4 py-2 bg-white bg-opacity-20 text-white rounded-lg hover:bg-opacity-30 transition-all">é¸æ“‡ç…§ç‰‡</button>
                                    <p class="text-white opacity-70 text-sm mt-2" id="upload-status-portrait">å°šæœªä¸Šå‚³ç…§ç‰‡</p>
                                </div>
                           </div>
                           <div>
                                <h3 class="text-lg font-semibold text-white mb-4">è®ŠåŒ–å¼µæ•¸</h3>
                                <div class="flex space-x-2" id="variations-selector">
                                    <button class="variation-btn w-10 h-10 rounded-lg font-medium transition-all selected" data-type="variation" data-value="1">1</button>
                                    <button class="variation-btn w-10 h-10 rounded-lg font-medium transition-all" data-type="variation" data-value="2">2</button>
                                    <button class="variation-btn w-10 h-10 rounded-lg font-medium transition-all" data-type="variation" data-value="3">3</button>
                                    <button class="variation-btn w-10 h-10 rounded-lg font-medium transition-all" data-type="variation" data-value="4">4</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Middle: Style Options -->
                    <div class="lg:col-span-1 space-y-6">
                         <div class="glass-effect rounded-2xl p-6 space-y-6">
                            <div>
                                <h3 class="text-lg font-semibold text-white mb-4">èƒŒæ™¯é¢¨æ ¼</h3>
                                <div class="grid grid-cols-2 gap-3" id="background-options"></div>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-white mb-4">æœè£é¢¨æ ¼</h3>
                                <div class="space-y-2 max-h-48 overflow-y-auto" id="clothing-options"></div>
                            </div>
                         </div>
                    </div>
                    <!-- Right: Effects & Preview -->
                    <div class="lg:col-span-1 space-y-6">
                         <div class="glass-effect rounded-2xl p-6 space-y-6">
                            <div>
                                <h3 class="text-lg font-semibold text-white mb-4">è¦–è¦ºæ•ˆæœ</h3>
                                <div class="grid grid-cols-2 gap-2" id="effect-options"></div>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-white mb-4">è§’åº¦æ§‹åœ–</h3>
                                <div class="space-y-2 max-h-48 overflow-y-auto" id="angle-options"></div>
                            </div>
                            <div id="preview-section-portrait" class="hidden">
                                <h3 class="text-lg font-semibold text-white mb-4">åŸåœ–é è¦½</h3>
                                <div class="preview-container">
                                    <img id="preview-image-portrait" class="preview-image" alt="é è¦½" />
                                </div>
                            </div>
                         </div>
                    </div>
                </div>
            </div>

            <!-- Sticker Mode -->
            <div id="sticker-mode" class="hidden">
                 <div class="grid lg:grid-cols-2 gap-8">
                    <!-- Left: Upload -->
                    <div class="lg:col-span-1">
                        <div class="glass-effect rounded-2xl p-6 space-y-6 h-full flex flex-col">
                           <h3 class="text-lg font-semibold text-white">1. æ‚¨çš„ç…§ç‰‡</h3>
                           <div class="upload-zone rounded-lg p-6 text-center flex-grow flex flex-col justify-center items-center" id="upload-zone-sticker">
                                <input type="file" id="file-input-sticker" accept="image/*" class="hidden"/>
                                <img id="preview-image-sticker" class="preview-image hidden max-h-64 mb-4 rounded-lg" alt="è²¼åœ–é è¦½" />
                                <div id="upload-prompt-sticker">
                                    <div class="text-6xl mb-4">ğŸ–¼ï¸</div>
                                    <p class="text-white mb-4">é»æ“Šæˆ–æ‹–æ‹½ç…§ç‰‡åˆ°é€™è£¡</p>
                                    <button id="upload-btn-sticker" class="px-5 py-2.5 bg-white bg-opacity-20 text-white rounded-lg hover:bg-opacity-30 transition-all">é¸æ“‡ç…§ç‰‡</button>
                                </div>
                                <p class="text-white opacity-70 text-sm mt-4" id="upload-status-sticker">å°šæœªä¸Šå‚³ç…§ç‰‡</p>
                            </div>
                        </div>
                    </div>
                     <!-- Right: Sticker Options -->
                    <div class="lg:col-span-1">
                        <div class="glass-effect rounded-2xl p-6 space-y-6">
                            <h3 class="text-lg font-semibold text-white">2. é¸æ“‡è²¼åœ–</h3>
                            <div class="space-y-4 p-4 bg-black bg-opacity-20 rounded-lg">
                                <h4 class="font-semibold text-white">âœ¨ AI è²¼åœ–å‰µæ„ç”¢ç”Ÿå™¨</h4>
                                <textarea id="sticker-idea-input" rows="2" class="w-full bg-black bg-opacity-30 rounded-lg p-2 text-white placeholder-gray-400 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="ä¾‹å¦‚ï¼šæˆ‘å®¶æ„›æ—è›‹çš„æ©˜è²“ã€è¾¦å…¬å®¤å°ˆç”¨..."></textarea>
                                 <button id="generate-idea-btn" class="w-full px-4 py-2 bg-yellow-500 text-black rounded-lg hover:bg-yellow-600 font-bold transition-all">ç”¢ç”Ÿé»å­</button>
                            </div>
                             <div>
                                <h4 class="text-md font-semibold text-white mb-3">é¸æ“‡æƒ³ç”Ÿæˆçš„è²¼åœ–ï¼š</h4>
                                <div class="grid grid-cols-3 gap-2" id="reaction-options">
                                    <!-- Reactions will be dynamically inserted here -->
                                </div>
                            </div>
                            <div class="border-t border-white/10 pt-4 mt-4 space-y-3">
                                <div class="flex justify-between items-center">
                                    <label for="toggle-cute-anime" class="font-medium text-white">å¯æ„›å‹•æ¼«</label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="toggle-cute-anime">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="flex justify-between items-center">
                                    <label for="toggle-add-text" class="font-medium text-white">åŠ ä¸Šæ–‡å­—</label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="toggle-add-text">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                 </div>
            </div>

            <!-- Photo Mode (äººçš®è§£æ†‚è™Ÿ) -->
            <div id="photo-mode" class="hidden">
                 <div class="grid lg:grid-cols-2 gap-8">
                    <!-- Left: Upload -->
                    <div class="lg:col-span-1">
                        <div class="glass-effect rounded-2xl p-6 space-y-6 h-full flex flex-col">
                           <h3 class="text-lg font-semibold text-white">1. ä¸Šå‚³æ‚¨çš„ç…§ç‰‡</h3>
                           <p class="text-sm text-white/70">ä¸Šå‚³æ‚¨çš„ç…§ç‰‡æˆ–äººç‰©æ‰‹ç¨¿ï¼Œè®“ AI ç‚ºæ‚¨å¯¦ç¾ç„¡é™å¯«çœŸå¯èƒ½ã€‚</p>
                           <div class="upload-zone rounded-lg p-6 text-center flex-grow flex flex-col justify-center items-center" id="upload-zone-photo">
                                <input type="file" id="file-input-photo" accept="image/*" class="hidden"/>
                                <img id="preview-image-photo" class="preview-image hidden max-h-64 mb-4 rounded-lg" alt="å¯«çœŸé è¦½" />
                                <div id="upload-prompt-photo">
                                    <div class="text-6xl mb-4">ğŸ‘¤</div>
                                    <p class="text-white mb-4">é»æ“Šæˆ–æ‹–æ‹½ç…§ç‰‡åˆ°é€™è£¡</p>
                                    <button id="upload-btn-photo" class="px-5 py-2.5 bg-white bg-opacity-20 text-white rounded-lg hover:bg-opacity-30 transition-all">é¸æ“‡ç…§ç‰‡</button>
                                </div>
                                <p class="text-white opacity-70 text-sm mt-4" id="upload-status-photo">å°šæœªä¸Šå‚³ç…§ç‰‡</p>
                            </div>
                        </div>
                    </div>
                     <!-- Right: Photo Theme Options -->
                    <div class="lg:col-span-1">
                        <div class="glass-effect rounded-2xl p-6 space-y-6">
                            <div>
                                <h3 class="text-lg font-semibold text-white">2. é¸æ“‡ AI åŠŸèƒ½</h3>
                                <div id="photo-theme-options" class="grid grid-cols-2 sm:grid-cols-3 gap-4 max-h-[50vh] overflow-y-auto p-1">
                                    <!-- Photo themes will be dynamically inserted here -->
                                </div>
                            </div>
                            <div class="border-t border-white/10 pt-4 mt-4">
                                <h3 class="text-lg font-semibold text-white mb-3">3. å¤šçµ¦ä¸€é»è§£æ†‚æç¤º (é¸å¡«)</h3>
                                <textarea id="photo-extra-prompt" rows="3" class="w-full bg-black bg-opacity-30 rounded-lg p-2 text-white placeholder-gray-400 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="ä¾‹å¦‚ï¼šæˆ´ä¸Šå¤ªé™½çœ¼é¡ã€ç©¿ä¸Šç´…è‰²æ´‹è£ã€èƒŒæ™¯æ”¹æˆä¸‹é›ªå¤©..."></textarea>
                            </div>
                        </div>
                    </div>
                 </div>
            </div>


            <!-- Universal Generate Button and Results -->
            <div class="mt-8">
                 <button id="generate-btn" class="w-full max-w-2xl mx-auto block py-4 px-6 rounded-lg font-semibold text-lg transition-all bg-gray-600 text-gray-400 cursor-not-allowed" disabled>
                    è«‹å…ˆä¸Šå‚³ç…§ç‰‡
                </button>
            </div>

            <div id="results-section" class="mt-8 hidden">
                <div class="glass-effect rounded-2xl p-6">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                        <h3 class="text-2xl font-bold text-white">ç”Ÿæˆçµæœ</h3>
                        <div class="flex gap-2">
                             <button id="download-all-btn" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all hidden">
                                ğŸ“¦ ä¸‹è¼‰ ZIP
                            </button>
                        </div>
                    </div>
                    <div id="processing-indicator" class="text-center py-12 hidden">
                        <div class="processing text-6xl mb-4">ğŸ¨</div>
                        <p class="text-white text-lg" id="processing-main-text">AI æ­£åœ¨ç”Ÿæˆæ‚¨çš„ä½œå“...</p>
                        <p class="text-white opacity-70 mt-2" id="processing-details">è«‹ç¨å€™ï¼Œé€™å¯èƒ½éœ€è¦å¹¾åˆ†é˜</p>
                    </div>
                    <div id="results-grid" class="grid sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 hidden">
                        <!-- Results will be dynamically generated -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center mt-12">
            <div class="glass-effect rounded-2xl p-4 max-w-md mx-auto inline-block">
                <p class="text-white opacity-80 text-sm mb-2">ğŸ“ é˜¿äº®è€å¸« AI å·¥ä½œå®¤</p>
                <div class="flex justify-center space-x-4 text-sm">
                    <a href="https://www.facebook.com/iddmail" target="_blank" class="text-white opacity-70 hover:opacity-100 transition-opacity">ğŸ“˜ Facebook</a>
                    <a href="https://www.youtube.com/@Liang-yt02" target="_blank" class="text-white opacity-70 hover:opacity-100 transition-opacity">ğŸ“º YouTube</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const CONFIG = {
             photoThemes: [
                { id: 'timeTravel', name: 'æ­²æœˆè¨˜æ†¶', icon: 'ğŸ•°ï¸', description: 'ç”Ÿæˆäººç‰©åœ¨ä¸åŒå¹´é½¡çš„é—œéµç…§ç‰‡ï¼Œè¨˜éŒ„äººç”Ÿé‡è¦æ™‚åˆ»ã€‚', 
                  prompts: [
                    { id: '1æ­²ç”Ÿæ—¥', base: 'A photo of the person as a 1-year-old baby at their birthday party.' },
                    { id: 'å¤§å­¸ç•¢æ¥­', base: 'A photo of the person graduating from university, wearing a cap and gown.' },
                    { id: 'å©šç¦®ç•¶å¤©', base: 'A wedding photo of the person with their partner.' },
                    { id: 'è¿æ¥æ–°ç”Ÿå…’', base: 'A heartwarming photo of the person holding their newborn baby.' },
                    { id: 'æ–°å®¶èˆ‡æ„›è»Š', base: 'A family photo of the person with their family in front of a new house and a car.' },
                    { id: 'å«é£´å¼„å­«', base: 'A photo of the person as a grandparent, happily playing with their grandchild.' }
                  ]
                },
                { id: 'styleMakeover', name: 'é¢¨æ ¼é€ å‹', icon: 'ğŸ‘•', description: 'ç‚ºç…§ç‰‡ä¸­çš„äººç‰©è¨­è¨ˆä¸€å¥—å®Œæ•´çš„æ™‚å°šé€ å‹ã€‚',
                  prompts: [
                    { id: 'è¡—é ­æ½®æµ', base: 'A full-body fashion shot of the person in a stylish streetwear outfit in a city.' },
                    { id: 'å„ªé›…æ™šå®´', base: 'The person dressed in an elegant evening gown or tuxedo for a formal event.' },
                    { id: 'æ³¢å¸Œç±³äº', base: 'The person in a bohemian style outfit at an outdoor music festival.' },
                    { id: 'å¾©å¤æ–æ»¾', base: 'The person in a vintage rock-and-roll outfit with a leather jacket.' },
                    { id: 'å•†å‹™ç²¾è‹±', base: 'The person in a sharp, modern business suit, looking professional.' },
                    { id: 'é‹å‹•ä¼‘é–’', base: 'The person in a high-end athleisure outfit.' }
                  ]
                },
                 { id: 'sportsStar', name: 'é‹å‹•æ‚å°‡', icon: 'ğŸ†', description: 'ç”Ÿæˆç©¿æ­é‹å‹•æœè£åœ¨å„ç¨®é‹å‹•ç«¶æŠ€å ´åˆä¸­å¤§å±•èº«æ‰‹çš„å¯«å¯¦ç…§ç‰‡ã€‚',
                  prompts: [
                    { id: 'ç±ƒçƒæ¯”è³½', base: 'Action shot of the person dunking a basketball in a packed arena.' },
                    { id: 'è¶³çƒå ´', base: 'Action shot of the person scoring a goal in a professional soccer match.' },
                    { id: 'ç¶²çƒå ´', base: 'Action shot of the person serving the ball on a professional tennis court like Wimbledon.' },
                    { id: 'å¥§é‹è³½é“', base: 'The person sprinting on an Olympic running track, crossing the finish line.' },
                    { id: 'å¥èº«æˆ¿', base: 'The person lifting heavy weights in a modern, well-equipped gym.' },
                    { id: 'æ»‘é›ªå ´', base: 'The person skiing down a snowy mountain slope at high speed.' }
                  ]
                },
                { id: 'flowerSea', name: 'èŠ±æµ·éŠè¨˜', icon: 'ğŸŒ¸', description: 'åœ¨å„å­£ç¯€çš„(èŠ±æµ·)çš„æ—…éŠç´€å¿µç…§ã€‚',
                   prompts: [
                    { id: 'è–°è¡£è‰ç”°', base: 'The person in a beautiful lavender field in Provence, France.' },
                    { id: 'å‘æ—¥è‘µèŠ±æµ·', base: 'The person standing in a vast sunflower field under a bright sun.' },
                    { id: 'æ«»èŠ±å¤§é“', base: 'The person walking under a canopy of blooming cherry blossoms in Japan.' },
                    { id: 'é¬±é‡‘é¦™èŠ±åœ’', base: 'The person in the middle of colorful tulip gardens in the Netherlands.' },
                    { id: 'æ²¹èœèŠ±ç”°', base: 'The person in a vibrant yellow rapeseed flower field.' },
                    { id: 'æ³¢æ–¯èŠèŠ±æµ·', base: 'The person surrounded by a sea of colorful cosmos flowers.' }
                  ]
                },
                { id: 'worldTour', name: 'ç’°éŠä¸–ç•Œ', icon: 'âœˆï¸', description: 'ç”Ÿæˆæ‚¨åœ¨ä¸–ç•Œå„åœ°è‘—åæ™¯é»çš„æ—…éŠç´€å¿µç…§ã€‚',
                  prompts: [
                    { id: 'å·´é»éµå¡”', base: 'In front of the Eiffel Tower in Paris on a sunny day.' },
                    { id: 'å¸Œè‡˜è–æ‰˜é‡Œå°¼', base: 'In Santorini, Greece, with the iconic white and blue buildings in the background.' },
                    { id: 'æ—¥æœ¬äº¬éƒ½', base: 'In a traditional street in Kyoto, Japan, with cherry blossoms or autumn leaves.' },
                    { id: 'ç´ç´„æ™‚ä»£å»£å ´', base: 'At night in Times Square, New York, surrounded by bright neon signs.' },
                    { id: 'å†°å³¶æ¥µå…‰', base: 'Under the magical Northern Lights (Aurora Borealis) in Iceland.' },
                    { id: 'å¨å°¼æ–¯é‹æ²³', base: 'On a gondola in a Venice canal, Italy.' }
                  ]
                },
                 { id: 'lifestyle', name: 'ç”Ÿæ´»éš¨æ‹', icon: 'â˜•', description: 'å‰µé€ åœ¨å’–å•¡å»³ã€è¡—é ­ç­‰å ´æ™¯çš„è‡ªç„¶ç”Ÿæ´»ç…§ã€‚',
                  prompts: [
                    { id: 'å’–å•¡å»³', base: 'The person enjoying a cup of coffee in a cozy, stylish cafe.' },
                    { id: 'è¡—é ­æ¼«æ­¥', base: 'A candid shot of the person walking on a bustling city street.' },
                    { id: 'åœ–æ›¸é¤¨', base: 'The person reading a book in a large, quiet library.' },
                    { id: 'é€›å¸‚é›†', base: 'The person exploring a vibrant local market.' },
                    { id: 'å…¬åœ’é‡é¤', base: 'The person having a picnic in a beautiful park on a sunny day.' },
                    { id: 'çœ‹å±•è¦½', base: 'The person looking at artwork in a modern art gallery.' }
                  ]
                },
                { id: 'proID', name: 'å°ˆæ¥­è­‰ä»¶ç…§', icon: 'ğŸ†”', description: 'ä¸€éµæ›´æ›æœè£èˆ‡èƒŒæ™¯ï¼Œè£½ä½œå°ˆæ¥­è­‰ä»¶ç…§ã€‚',
                   prompts: [
                    { id: 'è—åº•è¥¿è£', base: 'A professional ID photo of the person wearing a suit, with a blue background.' },
                    { id: 'ç™½åº•è¥¿è£', base: 'A professional ID photo of the person wearing a suit, with a white background.' },
                    { id: 'è—åº•è¥¯è¡«', base: 'A professional ID photo of the person wearing a formal shirt, with a blue background.' },
                    { id: 'ç™½åº•è¥¯è¡«', base: 'A professional ID photo of the person wearing a formal shirt, with a white background.' },
                    { id: 'éŸ“å¼è­‰ä»¶ç…§', base: 'A Korean-style ID photo with soft lighting and a neutral background.' },
                    { id: 'å°ˆæ¥­å½¢è±¡ç…§', base: 'A professional headshot for corporate or business use.' }
                  ]
                },
                { id: 'superChef', name: 'è¶…å‹ä¸»å»š', icon: 'ğŸ‘¨â€ğŸ³', description: 'ç”Ÿæˆç©¿æ­ä¸»å»šæœè£åœ¨å„ç¨®é¤é£²å»šæˆ¿å ´åˆä¸­å¤§å±•èº«æ‰‹çš„å¯«å¯¦ç…§ç‰‡ã€‚',
                   prompts: [
                    { id: 'ç±³å…¶æ—å»šæˆ¿', base: 'The person as a chef in a Michelin-starred restaurant kitchen, plating a dish.' },
                    { id: 'çƒ˜ç„™åŠ', base: 'The person as a baker, kneading dough in a rustic bakery.' },
                    { id: 'å£½å¸å§å°', base: 'The person as a sushi chef, skillfully preparing sushi at a counter.' },
                    { id: 'æˆ¶å¤–ç‡’çƒ¤', base: 'The person grilling food at an outdoor BBQ event.' },
                    { id: 'åˆ†å­æ–™ç†', base: 'The person as a chef creating a molecular gastronomy dish with smoke and foam.' },
                    { id: 'çƒ¹é£ªæ•™å®¤', base: 'The person teaching a cooking class to students.' }
                  ]
                },
                { id: 'superIdol', name: 'è¶…ç´šå¶åƒ', icon: 'ğŸ¤', description: 'åœ¨å„ç¨®ç¯€ç›®ã€èˆå°ã€ç°½å”±æœƒå ´åˆä¸­çš„å¯«å¯¦ç…§ç‰‡ã€‚',
                  prompts: [
                    { id: 'æ¼”å”±æœƒèˆå°', base: 'The person performing on a large concert stage with dramatic lighting.' },
                    { id: 'è„«å£ç§€å˜‰è³“', base: 'The person as a guest on a late-night talk show, sitting on the couch.' },
                    { id: 'ç²‰çµ²ç°½å”±æœƒ', base: 'The person signing autographs for fans at a fan meet event.' },
                    { id: 'èµ°ç´…åœ°æ¯¯', base: 'The person walking the red carpet at a movie premiere or awards ceremony.' },
                    { id: 'MVæ‹æ”ç¾å ´', base: 'The person in the middle of a dynamic music video shoot.' },
                    { id: 'éŸ³æ¨‚é ’çå…¸ç¦®', base: 'The person accepting an award on stage at a music awards ceremony.' }
                  ]
                },
            ],
            backgrounds: [
                { value: 'ç™½åº•è­‰ä»¶', label: 'ç™½åº•è­‰ä»¶', desc: 'æ¨™æº–ç´”ç™½ï¼Œé©åˆæ­£å¼ç”¨é€”', color: 'bg-white' },
                { value: 'å•†å‹™ç°', label: 'å•†å‹™ç°', desc: 'æ·ºç°ä¸­æ€§ï¼ŒæŸ”å…‰å°ˆæ¥­', color: 'bg-gray-200' },
                { value: 'ç§‘æŠ€è—æ¼¸å±¤', label: 'ç§‘æŠ€è—æ¼¸å±¤', desc: 'æ·±â†’æ·ºè—ï¼Œç§‘æŠ€å…‰æšˆ', color: 'bg-gradient-to-b from-blue-600 to-blue-300' },
                { value: 'å“ç‰Œè‰²', label: 'å“ç‰Œè‰²', desc: 'å–®è‰²ä¹¾æ·¨ï¼Œå¼·èª¿è­˜åˆ¥', color: 'bg-purple-400' },
                { value: 'æº«æš–ç±³è‰²', label: 'æº«æš–ç±³è‰²', desc: 'æº«é¦¨è¦ªå’Œï¼Œé©åˆæœå‹™æ¥­', color: 'bg-yellow-100' },
                { value: 'æ·±é‚ƒé»‘è‰²', label: 'æ·±é‚ƒé»‘è‰²', desc: 'é«˜ç«¯å¥¢è¯ï¼Œè—è¡“æ„Ÿå¼·', color: 'bg-gray-900' }
            ],
            clothing: [
                { value: '', label: 'ä¿ç•™åŸåœ–æœè£', desc: 'ä¸ä¿®æ”¹åŸæœ‰æœè£' },
                { value: 'æ·±è‰²è¥¿è£å¤–å¥—ï¼‹ç™½è¥¯è¡«', label: 'æ­£å¼è¥¿è£', desc: 'æ·±è‰²è¥¿è£å¤–å¥—ï¼‹ç™½è¥¯è¡«ï¼ˆæ­£å¼ï¼‰' },
                { value: 'æ·±è‰²è¥¿è£å¤–å¥—ï¼‹æ·ºè—è¥¯è¡«', label: 'å•†å‹™ä¼‘é–’', desc: 'æ·±è‰²è¥¿è£å¤–å¥—ï¼‹æ·ºè—è¥¯è¡«ï¼ˆç„¡é ˜å¸¶ï¼‰' },
                { value: 'é»‘è‰²é«˜é ˜æ¯›è¡£', label: 'ç°¡ç´„ç§‘æŠ€', desc: 'é»‘è‰²é«˜é ˜æ¯›è¡£ï¼ˆç°¡ç´„ç§‘æŠ€æ„Ÿï¼‰' },
                { value: 'æ·ºè—è¥¯è¡«', label: 'æ¸…çˆ½å°ˆæ¥­', desc: 'æ·ºè—è¥¯è¡«ï¼ˆæ¸…çˆ½å°ˆæ¥­ï¼‰' },
            ],
            effects: [
                { value: 'ç„¡æ•ˆæœ', label: 'ç„¡æ•ˆæœ' },
                { value: 'å¾©å¤é¢¨æ ¼ (Vintage)', label: 'å¾©å¤é¢¨æ ¼' },
                { value: 'é»‘ç™½ (Black and White)', label: 'é»‘ç™½' },
                { value: 'æ·±è¤è‰² (Sepia)', label: 'æ·±è¤è‰²' },
            ],
            angles: [
                { value: 'æ­£é¢è¦–è§’ï¼ˆèƒ¸ä¸ŠåŠèº«ï¼‰', label: 'æ­£é¢æ¨™æº–' },
                { value: 'å·¦å´ 45Â° åŠå´è‡‰', label: 'å·¦å´45Â°' },
                { value: 'å³å´ 45Â° åŠå´è‡‰', label: 'å³å´45Â°' },
            ],
            reactions: ['é–‹å¿ƒ', 'å‚·å¿ƒ', 'å¤§ç¬‘', 'ç”Ÿæ°£', 'æ„›å¿ƒ', 'OK']
        };

        // --- APPLICATION STATE ---
        const AppState = {
            currentMode: 'portrait', // 'portrait', 'sticker', or 'photo'
            portraitProcessMode: 'single', // 'single' or 'batch'
            uploadedImages: [],
            settings: {
                portrait: {
                    background: 'ç™½åº•è­‰ä»¶', clothing: '', effect: 'ç„¡æ•ˆæœ',
                    angle: 'æ­£é¢è¦–è§’ï¼ˆèƒ¸ä¸ŠåŠèº«ï¼‰', variations: 1
                },
                sticker: {
                    reactions: ['é–‹å¿ƒ'], isCuteAnime: false, addText: false
                },
                photo: {
                    theme: 'timeTravel',
                    additionalPrompt: ''
                }
            },
            isProcessing: false,
            results: []
        };
        
        // --- NOTIFICATION SYSTEM ---
        const NotificationSystem = {
            show(message, isError = false, duration = 3000) {
                const el = document.getElementById('notification');
                if (el) {
                    el.textContent = message;
                    el.className = `notification show ${isError ? 'error' : ''}`;
                    setTimeout(() => el.classList.remove('show'), duration);
                }
            }
        };

        // --- API MANAGER ---
        const APIManager = {
             async retryFetch(url, options, maxRetries = 3) {
                let lastError = null;
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        const response = await fetch(url, options);
                        if (!response.ok) {
                            let errorText = `HTTP éŒ¯èª¤: ${response.status}`;
                            try {
                                const errorJson = await response.json();
                                errorText = errorJson.error?.message || JSON.stringify(errorJson);
                            } catch (e) {
                                errorText = (await response.text()) || errorText;
                            }
                            throw new Error(errorText);
                        }
                        return await response.json();
                    } catch (error) {
                        lastError = error;
                        console.error(`API è«‹æ±‚å¤±æ•— (ç¬¬ ${i + 1} æ¬¡å˜—è©¦):`, error.message);
                        if (i < maxRetries - 1) {
                             await new Promise(res => setTimeout(res, 1000 * Math.pow(2, i))); // Exponential backoff
                        }
                    }
                }
                throw new Error(`API è«‹æ±‚åœ¨ ${maxRetries} æ¬¡å˜—è©¦å¾Œä»ç„¶å¤±æ•—: ${lastError.message}`);
            },
            
            async generate(imageData, settings) {
                const apiKey = "AIzaSyAZP2k3NB42u3jG2USy1_GjOc9oQS2QYS8"; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;
                
                // Safer Data URL parsing
                if (!imageData || !imageData.startsWith('data:image')) {
                    throw new Error('æä¾›çš„åœ–ç‰‡è³‡æ–™ç„¡æ•ˆ');
                }
                const parts = imageData.split(',');
                if (parts.length !== 2) throw new Error('ç„¡æ•ˆçš„ base64 åœ–ç‰‡è³‡æ–™æ ¼å¼');
                const meta = parts[0];
                const base64Data = parts[1];
                const mimeTypeMatch = meta.match(/:(.*?);/);
                if (!mimeTypeMatch || !mimeTypeMatch[1]) throw new Error('ç„¡æ³•å¾åœ–ç‰‡è³‡æ–™ä¸­è§£æ MIME é¡å‹');
                const mimeType = mimeTypeMatch[1];
                
                let prompt;
                if (AppState.currentMode === 'portrait') {
                     prompt = `è«‹æ ¹æ“šé€™å¼µç…§ç‰‡ï¼Œç”Ÿæˆä¸€å¼µå°ˆæ¥­çš„å•†æ¥­è‚–åƒç…§ã€‚é‡è¦ï¼šè«‹å‹™å¿…ä¿æŒäººç‰©çš„è‡‰éƒ¨ç‰¹å¾µã€äº”å®˜å’Œèº«ä»½èˆ‡åŸåœ–å®Œå…¨ä¸€è‡´ï¼Œåªå°é¢¨æ ¼å’ŒèƒŒæ™¯é€²è¡Œèª¿æ•´ã€‚
å…·é«”è¦æ±‚ï¼š- èƒŒæ™¯é¢¨æ ¼: ${settings.background} - æœè£é¢¨æ ¼: ${settings.clothing || 'ä¿ç•™åŸå§‹æœè£'} - è¦–è¦ºæ•ˆæœ: ${settings.effect} - è§’åº¦èˆ‡æ§‹åœ–: ${settings.angle} - æ•´é«”é¢¨æ ¼: å°ˆæ¥­é ­åƒã€é«˜å“è³ªã€æ¼”æ’­å®¤ç‡ˆå…‰ã€é©åˆå•†æ¥­ç”¨é€”ã€‚`;
                } else if (AppState.currentMode === 'sticker') {
                    let stylePrompt = AppState.settings.sticker.isCuteAnime ? "é¢¨æ ¼æ”¹ç‚ºå¯æ„›å‹•æ¼«Qç‰ˆé¢¨æ ¼ã€‚" : "é¢¨æ ¼è¦ç”Ÿå‹•æ´»æ½‘ï¼Œå¼•äººæ³¨ç›®ã€‚";
                    let textPrompt = AppState.settings.sticker.addText ? `é‡è¦ï¼šè«‹åœ¨è²¼åœ–ä¸ŠåŠ ä¸Šç¬¦åˆã€Œ${settings.reaction}ã€æƒ…ç·’çš„ç°¡çŸ­è‹±æ–‡å–®å­—æˆ–ç‰‡èªï¼ˆä¾‹å¦‚ 'OK', 'Cool', 'LOL'ï¼‰ã€‚è«‹å‹™å¿…ä½¿ç”¨é¢¨æ ¼åŒ–çš„å­—é«”ï¼Œä¸¦ä¸”ä¸è¦ä½¿ç”¨ä»»ä½•ä¸­æ–‡å­—å…ƒã€‚` : "é‡è¦ï¼šè«‹ä¸è¦åœ¨åœ–ç‰‡ä¸Šæ·»åŠ ä»»ä½•æ–‡å­—ã€‚";
                    prompt = `å°‡é€™å¼µç…§ç‰‡ä¸­çš„äººç‰©è®Šæˆä¸€å€‹æœ‰è¶£çš„æ•¸ä½èŠå¤©è²¼åœ–ï¼Œç”¨ä¾†è¡¨é”ã€Œ${settings.reaction}ã€çš„æƒ…ç·’æˆ–å‹•ä½œã€‚${textPrompt} è«‹å°‡äººç‰©å»èƒŒï¼ˆèƒŒæ™¯è¨­ç‚ºé€æ˜ï¼‰ï¼Œä¸¦åœ¨äººç‰©å‘¨åœåŠ ä¸Šæ¸…æ™°ã€ç²—é«”çš„ç™½è‰²è¼ªå»“ã€‚${stylePrompt}`;
                } else { // Photo Mode
                    let basePrompt = `Take the provided photo of a person and realistically place them in the famous location or scenario described: ${settings.prompt}.`;
                    const additionalPrompt = AppState.settings.photo.additionalPrompt.trim();
                    if (additionalPrompt) {
                        basePrompt += ` Also apply these modifications: ${additionalPrompt}.`;
                    }
                    prompt = basePrompt + ` Ensure the person's face and identity are perfectly preserved. The final image should be a high-quality, photorealistic shot.`;
                }

                const payload = {
                    contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType, data: base64Data } }] }],
                    generationConfig: { responseModalities: ['IMAGE'] },
                };

                const result = await this.retryFetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const generatedBase64 = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                if (!generatedBase64) throw new Error('API å›æ‡‰ä¸­æœªæ‰¾åˆ°åœ–ç‰‡è³‡æ–™');
                return `data:image/png;base64,${generatedBase64}`;
            },

            async generateIdea(theme) {
                const apiKey = "AIzaSyAZP2k3NB42u3jG2USy1_GjOc9oQS2QYS8"; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const prompt = `é‡å°ã€Œ${theme}ã€é€™å€‹ä¸»é¡Œï¼Œç”¢ç”Ÿ 8 å€‹é©åˆç•¶ä½œèŠå¤©è²¼åœ–çš„ç°¡çŸ­å‰µæ„é»å­æˆ–åæ‡‰ã€‚é»å­æ‡‰è©²æ˜¯å‹•è©ç‰‡èªæˆ–ç°¡çŸ­æè¿°ï¼Œä¾‹å¦‚ï¼šã€Œå¯«ä½œæ¥­ã€ã€ã€Œèˆ‰æ‰‹ç™¼å•ã€ã€ã€Œæ‰“çŒç¡ã€ã€‚`;
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: { type: "ARRAY", items: { type: "STRING" } }
                    }
                };
                const result = await this.retryFetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const jsonText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!jsonText) throw new Error('API æœªè¿”å›æœ‰æ•ˆçš„é»å­');
                return JSON.parse(jsonText);
            }
        };
        
        // --- UI MANAGER ---
        const UIManager = {
            init() {
                this.renderOptions('backgrounds', document.getElementById('background-options'), this.createBackgroundCard);
                this.renderOptions('clothing', document.getElementById('clothing-options'), this.createSimpleCard);
                this.renderOptions('effects', document.getElementById('effect-options'), this.createTinyCard);
                this.renderOptions('angles', document.getElementById('angle-options'), this.createTinyCard);
                this.renderOptions('reactions', document.getElementById('reaction-options'), this.createReactionCard);
                this.renderPhotoThemes();
                
                this.updateSelected('background', AppState.settings.portrait.background);
                this.updateSelected('clothing', AppState.settings.portrait.clothing);
                this.updateSelected('effect', AppState.settings.portrait.effect);
                this.updateSelected('angle', AppState.settings.portrait.angle);
                this.updateSelected('reaction', AppState.settings.sticker.reactions);
                this.updateSelected('theme', AppState.settings.photo.theme);
                
                this.updateUploadStatus();
            },

            renderOptions(configKey, container, cardCreator) {
                if (!container) return;
                const options = CONFIG[configKey];
                container.innerHTML = options.map(option => cardCreator(option, configKey.slice(0, -1))).join('');
            },
            
            renderPhotoThemes() {
                const container = document.getElementById('photo-theme-options');
                if(!container) return;
                container.innerHTML = CONFIG.photoThemes.map(theme => `
                    <div class="theme-card glass-effect p-4 rounded-lg flex flex-col items-center text-center h-full" data-type="theme" data-value="${theme.id}">
                        <div class="text-4xl mb-2">${theme.icon}</div>
                        <h4 class="font-semibold text-white mb-1 text-sm">${theme.name}</h4>
                        <p class="text-xs text-white/70 flex-grow">${theme.description}</p>
                    </div>
                `).join('');
            },

            createBackgroundCard: (option, type) => `
                <div class="option-card p-3 rounded-lg bg-white bg-opacity-10" data-type="${type}" data-value="${option.value}">
                    <div class="${option.color} w-full h-8 rounded mb-2"></div>
                    <p class="text-white text-sm font-medium">${option.label}</p>
                    <p class="text-white opacity-70 text-xs">${option.desc}</p>
                </div>`,
            
            createSimpleCard: (option, type) => `
                <div class="option-card p-3 rounded-lg bg-white bg-opacity-10" data-type="${type}" data-value="${option.value}">
                    <p class="text-white text-sm font-medium">${option.label}</p>
                    <p class="text-white opacity-70 text-xs">${option.desc}</p>
                </div>`,

            createTinyCard: (option, type) => `
                 <div class="option-card p-2 rounded-lg text-center bg-white bg-opacity-10" data-type="${type}" data-value="${option.value}">
                    <p class="text-white text-xs font-medium">${option.label}</p>
                 </div>`,
            
            createReactionCard: (option, type) => `
                <button class="reaction-btn p-2 rounded-lg text-center bg-white bg-opacity-10" data-type="${type}" data-value="${option}">
                    <span class="text-white text-sm font-medium">${option}</span>
                </button>`,

            updateReactionButtons(reactions) {
                const container = document.getElementById('reaction-options');
                if (!container || !reactions || reactions.length === 0) return;
                container.innerHTML = reactions.map(reaction => this.createReactionCard(reaction, 'reaction')).join('');
                const newSelection = reactions[0];
                AppState.settings.sticker.reactions = [newSelection];
                this.updateSelected('reaction', AppState.settings.sticker.reactions);
            },

            updateSelected(type, valueOrValues) {
                document.querySelectorAll(`[data-type="${type}"]`).forEach(el => {
                    const elValue = el.dataset.value;
                    let isSelected = Array.isArray(valueOrValues) ? valueOrValues.includes(elValue) : elValue === valueOrValues;
                    el.classList.toggle('selected', isSelected);
                });
            },

            setMode(mode) {
                AppState.currentMode = mode;
                ['portrait', 'sticker', 'photo'].forEach(m => {
                    document.getElementById(`${m}-mode`).classList.toggle('hidden', mode !== m);
                    const btn = document.getElementById(`mode-btn-${m}`);
                    btn.classList.toggle('selected', mode === m);
                    btn.classList.toggle('bg-white', mode !== m);
                    btn.classList.toggle('bg-opacity-10', mode !== m);

                });
                this.updateUploadStatus();
            },
            
            updateUploadStatus() {
                const statusEl = document.getElementById(`upload-status-${AppState.currentMode}`);
                const generateBtn = document.getElementById('generate-btn');
                const hasImages = AppState.uploadedImages.length > 0;

                if (statusEl) {
                    statusEl.textContent = hasImages ? `å·²é¸æ“‡ ${AppState.uploadedImages.length} å¼µç…§ç‰‡` : `å°šæœªä¸Šå‚³ç…§ç‰‡`;
                }

                if (generateBtn) {
                    generateBtn.disabled = !hasImages || AppState.isProcessing;
                    if (!hasImages) {
                        generateBtn.textContent = 'è«‹å…ˆä¸Šå‚³ç…§ç‰‡';
                        generateBtn.className = 'w-full max-w-2xl mx-auto block py-4 px-6 rounded-lg font-semibold text-lg transition-all bg-gray-600 text-gray-400 cursor-not-allowed';
                    } else {
                        generateBtn.textContent = 'âœ¨ é–‹å§‹ç”Ÿæˆ';
                        generateBtn.className = 'w-full max-w-2xl mx-auto block py-4 px-6 rounded-lg font-semibold text-lg transition-all bg-gradient-to-r from-purple-600 to-indigo-600 text-white hover:opacity-90';
                    }
                }
            },

            showPreview(imageData) {
                const mode = AppState.currentMode;
                const previewImage = document.getElementById(`preview-image-${mode}`);
                const uploadPrompt = document.getElementById(`upload-prompt-${mode}`);

                if (uploadPrompt) uploadPrompt.classList.add('hidden');
                if(previewImage) {
                    previewImage.src = imageData;
                    previewImage.classList.remove('hidden');
                }
                
                // Special case for portrait mode which has a wrapper section
                if (mode === 'portrait') {
                     const previewSection = document.getElementById(`preview-section-portrait`);
                     if (previewSection) previewSection.classList.remove('hidden');
                }
            },

            toggleProcessing(isProcessing, details = '') {
                AppState.isProcessing = isProcessing;
                document.getElementById('results-section').classList.toggle('hidden', !isProcessing && AppState.results.length === 0);
                document.getElementById('processing-indicator').classList.toggle('hidden', !isProcessing);
                document.getElementById('results-grid').classList.toggle('hidden', isProcessing || AppState.results.length === 0);

                if (isProcessing) {
                    const mainText = {
                        portrait: 'AI æ­£åœ¨ç”Ÿæˆæ‚¨çš„å°ˆæ¥­äººåƒ...',
                        sticker: 'AI æ­£åœ¨è£½ä½œæ‚¨çš„å°ˆå±¬è²¼åœ–...',
                        photo: 'AI æ­£åœ¨ç”Ÿæˆæ‚¨çš„ä¸»é¡Œå¯«çœŸ...'
                    }[AppState.currentMode];
                    document.getElementById('processing-main-text').textContent = mainText;
                    document.getElementById('processing-details').textContent = details;
                    document.getElementById('results-grid').innerHTML = '';
                    document.getElementById('download-all-btn').classList.add('hidden');
                }
                this.updateUploadStatus();
            },

            showResults(results) {
                const resultsGrid = document.getElementById('results-grid');
                if (!resultsGrid) return;

                resultsGrid.innerHTML = results.map((result, index) => `
                    <div class="result-card rounded-lg p-4">
                        <img src="${result.url}" alt="ç”Ÿæˆçµæœ ${index + 1}" class="w-full h-48 object-cover rounded-lg mb-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-sm truncate pr-2">${result.originalName}</span>
                            <button onclick="downloadImage('${result.url}', 'generated_${result.originalName.replace(/\s/g, '_')}.png')"
                                class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm transition-colors flex-shrink-0">
                                ä¸‹è¼‰
                            </button>
                        </div>
                    </div>`).join('');
                
                if (results.length > 0) {
                    document.getElementById('download-all-btn').classList.remove('hidden');
                }
            }
        };

        // --- FILE HANDLING ---
        const FileHandler = {
            handleFiles: async (files) => {
                const imagePromises = Array.from(files).map(file => new Promise((resolve, reject) => {
                    if (!file.type.startsWith('image/')) return reject();
                    const reader = new FileReader();
                    reader.onload = e => resolve({ dataUrl: e.target.result, name: file.name });
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                }));

                const results = await Promise.allSettled(imagePromises);
                const successful = results.filter(r => r.status === 'fulfilled').map(r => r.value);

                if (successful.length > 0) {
                    if (AppState.currentMode === 'portrait' && AppState.portraitProcessMode === 'batch') {
                         AppState.uploadedImages = successful;
                    } else {
                        AppState.uploadedImages = [successful[0]];
                    }
                    UIManager.updateUploadStatus();
                    UIManager.showPreview(successful[0].dataUrl);
                    NotificationSystem.show(`å·²æˆåŠŸè¼‰å…¥ ${successful.length} å¼µç…§ç‰‡`);
                } else {
                    NotificationSystem.show('æœªé¸æ“‡æœ‰æ•ˆçš„åœ–ç‰‡æª”æ¡ˆ', true);
                }
            }
        };

        // --- CORE LOGIC ---
        const App = {
            async generate() {
                if (AppState.uploadedImages.length === 0) return NotificationSystem.show('è«‹å…ˆä¸Šå‚³ç…§ç‰‡', true);
                if (AppState.isProcessing) return;

                AppState.results = [];
                const allResults = [];
                UIManager.toggleProcessing(true, `æº–å‚™é–‹å§‹ç”Ÿæˆ...`);
                
                try {
                    if (AppState.currentMode === 'portrait') {
                        const settings = AppState.settings.portrait;
                        for (let image of AppState.uploadedImages) {
                            for (let v = 0; v < settings.variations; v++) {
                                UIManager.toggleProcessing(true, `æ­£åœ¨è™•ç†ï¼š${image.name} (ç¬¬ ${v + 1} / ${settings.variations} å€‹è®ŠåŒ–)`);
                                const url = await APIManager.generate(image.dataUrl, settings);
                                allResults.push({ url, originalName: image.name.split('.')[0], variation: v + 1 });
                            }
                        }
                    } else if (AppState.currentMode === 'sticker') {
                        const image = AppState.uploadedImages[0];
                        const selectedReactions = AppState.settings.sticker.reactions;
                        for (let i = 0; i < selectedReactions.length; i++) {
                            const reaction = selectedReactions[i];
                            UIManager.toggleProcessing(true, `æ­£åœ¨è£½ä½œè²¼åœ–ï¼š${reaction} (${i + 1} / ${selectedReactions.length})`);
                            const url = await APIManager.generate(image.dataUrl, { reaction });
                            allResults.push({ url, originalName: reaction, variation: i + 1 });
                        }
                    } else if (AppState.currentMode === 'photo') {
                        const image = AppState.uploadedImages[0];
                        const selectedTheme = CONFIG.photoThemes.find(t => t.id === AppState.settings.photo.theme);
                        if (!selectedTheme) throw new Error('è«‹é¸æ“‡ä¸€å€‹æœ‰æ•ˆçš„å¯«çœŸä¸»é¡Œ');
                        
                        const promptsToRun = selectedTheme.prompts;
                        UIManager.toggleProcessing(true, `æº–å‚™ç”Ÿæˆ ${promptsToRun.length} å¼µã€Œ${selectedTheme.name}ã€å¯«çœŸ...`);

                        for (let i = 0; i < promptsToRun.length; i++) {
                            const p = promptsToRun[i];
                            UIManager.toggleProcessing(true, `æ­£åœ¨ç”Ÿæˆï¼š${p.id} (${i + 1}/${promptsToRun.length})`);
                            const url = await APIManager.generate(image.dataUrl, { prompt: p.base });
                            allResults.push({ url, originalName: p.id, variation: i + 1 });
                        }
                    }

                    AppState.results = allResults;
                    if (allResults.length > 0) {
                        NotificationSystem.show(`æˆåŠŸç”Ÿæˆ ${allResults.length} å€‹ä½œå“ï¼`);
                    } else {
                        throw new Error('æ‰€æœ‰ç”Ÿæˆä»»å‹™å‡å¤±æ•—');
                    }
                } catch (error) {
                    console.error('ç”Ÿæˆå¤±æ•—:', error);
                    NotificationSystem.show(`ç”Ÿæˆå¤±æ•—ï¼š${error.message}`, true);
                } finally {
                    UIManager.toggleProcessing(false);
                    UIManager.showResults(allResults);
                }
            }
        };

        // --- HELPERS & EVENT LISTENERS ---
        function downloadImage(url, filename) {
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function setupEventListeners() {
            // Mode Switcher
            document.getElementById('mode-btn-portrait').addEventListener('click', () => UIManager.setMode('portrait'));
            document.getElementById('mode-btn-sticker').addEventListener('click', () => UIManager.setMode('sticker'));
            document.getElementById('mode-btn-photo').addEventListener('click', () => UIManager.setMode('photo'));

            // File Uploads
            ['portrait', 'sticker', 'photo'].forEach(mode => {
                document.getElementById(`upload-btn-${mode}`).addEventListener('click', () => document.getElementById(`file-input-${mode}`).click());
                document.getElementById(`file-input-${mode}`).addEventListener('change', e => e.target.files.length > 0 && FileHandler.handleFiles(e.target.files));
                const zone = document.getElementById(`upload-zone-${mode}`);
                zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
                zone.addEventListener('dragleave', e => { e.preventDefault(); zone.classList.remove('dragover'); });
                zone.addEventListener('drop', e => {
                    e.preventDefault();
                    zone.classList.remove('dragover');
                    e.dataTransfer.files.length > 0 && FileHandler.handleFiles(e.dataTransfer.files);
                });
            });
            
            // Portrait settings
            document.getElementById('portrait-mode-single').addEventListener('click', e => {
                AppState.portraitProcessMode = 'single';
                e.target.classList.add('bg-blue-500', 'text-white');
                document.getElementById('portrait-mode-batch').classList.remove('bg-blue-500', 'text-white');
            });
             document.getElementById('portrait-mode-batch').addEventListener('click', e => {
                AppState.portraitProcessMode = 'batch';
                e.target.classList.add('bg-blue-500', 'text-white');
                document.getElementById('portrait-mode-single').classList.remove('bg-blue-500', 'text-white');
            });

            // Universal Settings Click
            document.body.addEventListener('click', e => {
                const card = e.target.closest('[data-type]');
                if (!card) return;
                const { type, value } = card.dataset;

                if (type === 'variation') {
                    AppState.settings.portrait.variations = parseInt(value);
                    UIManager.updateSelected('variation', value);
                } else if (type === 'reaction') {
                    const reactions = AppState.settings.sticker.reactions;
                    const index = reactions.indexOf(value);
                    if (index > -1) {
                        if (reactions.length > 1) reactions.splice(index, 1);
                    } else {
                        reactions.push(value);
                    }
                    UIManager.updateSelected('reaction', reactions);
                } else if (type === 'theme') {
                    AppState.settings.photo.theme = value;
                     UIManager.updateSelected('theme', value);
                } else if (AppState.currentMode === 'portrait') {
                   AppState.settings.portrait[type] = value;
                   UIManager.updateSelected(type, value);
                }
            });
            
            // Photo Mode Extra Prompt
            document.getElementById('photo-extra-prompt').addEventListener('input', e => {
                AppState.settings.photo.additionalPrompt = e.target.value;
            });

            // Sticker idea generator
            document.getElementById('generate-idea-btn').addEventListener('click', async () => {
                const ideaInput = document.getElementById('sticker-idea-input');
                const ideaBtn = document.getElementById('generate-idea-btn');
                const theme = ideaInput.value.trim();
                if (!theme) return NotificationSystem.show('è«‹å…ˆè¼¸å…¥æ‚¨çš„æƒ³æ³•ä¸»é¡Œ', true);
                
                const originalText = ideaBtn.innerHTML;
                ideaBtn.innerHTML = 'ğŸ§  æ­£åœ¨ç”¢ç”Ÿé»å­...';
                ideaBtn.disabled = true;

                try {
                    const newReactions = await APIManager.generateIdea(theme);
                    UIManager.updateReactionButtons(newReactions);
                    NotificationSystem.show('å·²æ ¹æ“šæ‚¨çš„ä¸»é¡Œç”¢ç”Ÿæ–°é»å­ï¼');
                } catch (error) {
                    NotificationSystem.show(`é»å­ç”¢ç”Ÿå¤±æ•—: ${error.message}`, true);
                } finally {
                    ideaBtn.innerHTML = originalText;
                    ideaBtn.disabled = false;
                }
            });
            
            // Sticker Toggles
            document.getElementById('toggle-cute-anime').addEventListener('change', e => { AppState.settings.sticker.isCuteAnime = e.target.checked; });
            document.getElementById('toggle-add-text').addEventListener('change', e => { AppState.settings.sticker.addText = e.target.checked; });

            // Main Generate & Download Buttons
            document.getElementById('generate-btn').addEventListener('click', App.generate);
            document.getElementById('download-all-btn').addEventListener('click', () => {
                 AppState.results.forEach((result, index) => {
                    setTimeout(() => downloadImage(result.url, `generated_${result.originalName.replace(/\s/g, '_')}_${result.variation}.png`), index * 200);
                });
            });
        }
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            UIManager.init();
            setupEventListeners();
            NotificationSystem.show('æ­¡è¿ä½¿ç”¨ï¼è«‹é¸æ“‡æ¨¡å¼ä¸¦ä¸Šå‚³ç…§ç‰‡', false, 4000);
        });
    </script>
</body>
</html>


