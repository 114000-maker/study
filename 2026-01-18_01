import React, { useState, useEffect, useRef } from 'react';
import { User, BookOpen, Star, Sparkles, Copy, RotateCcw, PenTool, CheckCircle2, Wand2, Users, FileSpreadsheet, Trash2, Plus, GraduationCap, X, Save, HelpCircle, Sun, Moon, Printer, Upload, FileDown, Eraser, AlertTriangle, AlignLeft, Info, DownloadCloud, UploadCloud } from 'lucide-react';

// --- å­å…ƒä»¶æå– (è§£æ±ºç•«é¢è·³å‹•å•é¡Œçš„æ ¸å¿ƒ) ---

const GradeInput = ({ label, value, onChange, themeStyles }) => (
  <div className="flex flex-col gap-1">
    <label className="text-xs font-bold text-gray-500">{label}</label>
    <input 
      type="number" 
      value={value} 
      onChange={(e) => onChange(e.target.value)} 
      placeholder="-" 
      className={`w-full px-2 py-1.5 border rounded text-sm outline-none focus:ring-1 ${themeStyles.borderPrimary} ${themeStyles.highlight}`} 
    />
  </div>
);

const SelectionSection = ({ title, icon: Icon, defaultItems, customItems, selectedItems, category, colorBorder, hasLevelFilter, hasSubjectFilter, onSelection, onOpenCustom, onDeleteCustom, themeStyles }) => {
  const [levelFilter, setLevelFilter] = useState('all');
  const [subjectFilter, setSubjectFilter] = useState('all');
  const allItems = [...(customItems || []), ...defaultItems];
  const filteredItems = allItems.filter(item => {
    let mLevel = !hasLevelFilter || levelFilter === 'all' || item.level === levelFilter;
    let mSubject = !hasSubjectFilter || subjectFilter === 'all' || (subjectFilter === 'general' ? item.subject === 'general' : item.subject === subjectFilter);
    return mLevel && mSubject;
  });

  return (
    <div className={`mb-4 p-4 rounded-xl border-l-4 shadow-sm bg-white ${colorBorder}`}>
      <div className="flex flex-col md:flex-row md:items-center justify-between mb-3 gap-2">
        <div className="flex items-center gap-2">
          <Icon className={`w-5 h-5 ${themeStyles.icon}`} />
          <h3 className={`font-bold text-lg ${themeStyles.textPrimary}`}>{title}</h3>
          <button onClick={() => onOpenCustom(category)} className="ml-2 flex items-center gap-1 text-xs px-2 py-1 rounded bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors"><Plus className="w-3 h-3" /> è‡ªè¨‚</button>
        </div>
        <div className="flex flex-wrap gap-2">
          {hasSubjectFilter && <select value={subjectFilter} onChange={(e) => setSubjectFilter(e.target.value)} className="text-sm border border-gray-300 rounded px-2 py-1 bg-gray-50"><option value="all">å…¨ç§‘</option><option value="general">ä¸€èˆ¬</option><option value="chinese">åœ‹èª</option><option value="math">æ•¸å­¸</option><option value="science">è‡ªç„¶/ç†åŒ–/ç”Ÿç‰©</option><option value="arts">è—å¥/ç¤¾æœƒ/ç¶œåˆ</option></select>}
          {hasLevelFilter && <div className="flex bg-gray-100 rounded p-1">{['all','excellent','stable','improve'].map(l => <button key={l} onClick={()=>setLevelFilter(l)} className={`px-2 py-1 text-xs rounded transition-all ${levelFilter===l ? 'bg-white shadow-sm font-medium text-gray-800' : 'text-gray-500'}`}>{l==='all'?'å…¨éƒ¨':l==='excellent'?'å„ªç•°':l==='stable'?'å¹³ç©©':'éœ€åŠªåŠ›'}</button>)}</div>}
        </div>
      </div>
      <div className="flex flex-wrap gap-2">
        {filteredItems.length > 0 ? filteredItems.map((item) => {
          const isSel = selectedItems.some(i => i.id === item.id);
          const isCust = item.id.toString().startsWith('custom');
          let borderColor = 'border-gray-200';
          if (!isSel) { if (item.level === 'excellent') borderColor = 'border-l-4 border-l-green-400'; if (item.level === 'improve') borderColor = 'border-l-4 border-l-orange-300'; }
          return (
            <div key={item.id} className="relative group">
              <button 
                onClick={() => onSelection(category, item)} 
                className={`px-3 py-2 text-sm rounded transition-all border shadow-sm text-left flex items-center ${isSel ? `${themeStyles.buttonPrimary} ring-2 ring-offset-1 ${themeStyles.highlight}` : `bg-white text-gray-600 hover:bg-gray-50 ${borderColor}`} ${isCust ? 'pr-8 border-dashed' : ''}`}
                type="button" 
              >
                {item.label}
              </button>
              {isCust && <button onClick={(e) => { e.stopPropagation(); onDeleteCustom(category, item.id); }} className="absolute right-1 top-1/2 -translate-y-1/2 p-1 text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100"><X className="w-3 h-3" /></button>}
            </div>
          );
        }) : <div className="text-gray-400 text-sm py-2">ç„¡é¸é …</div>}
      </div>
    </div>
  );
};

// --- ä¸»å…ƒä»¶ ---

const CommentGenerator = () => {
  // --- å¸¸æ•¸èˆ‡è³‡æ–™åº« ---
  const DEFAULT_STUDENT_COUNT = 40; 
  const STORAGE_KEY = 'comment_generator_data_v8'; 
  const CUSTOM_DATA_KEY = 'comment_generator_custom_v1';
  const apiKey = ""; 

  // ä¸»é¡Œè¨­å®š
  const themes = {
    blue: {
      name: 'å°ˆæ¥­è—',
      bgMain: 'bg-slate-100',
      bgSidebar: 'bg-white',
      bgHeader: 'bg-white',
      textPrimary: 'text-blue-800',
      textSecondary: 'text-blue-600',
      borderPrimary: 'border-blue-500',
      buttonPrimary: 'bg-blue-600 hover:bg-blue-700 text-white',
      buttonSecondary: 'bg-blue-50 text-blue-600 hover:bg-blue-100',
      accent: 'bg-blue-100',
      icon: 'text-blue-600',
      highlight: 'ring-blue-500',
      sectionUser: 'border-blue-500',
      sectionBehavior: 'border-yellow-500',
      sectionAcademic: 'border-green-500',
      sectionFuture: 'border-purple-500',
    },
    warm: {
      name: 'è­·çœ¼æš–',
      bgMain: 'bg-stone-100', 
      bgSidebar: 'bg-[#fdfbf7]', 
      bgHeader: 'bg-[#fdfbf7]',
      textPrimary: 'text-amber-900',
      textSecondary: 'text-amber-700',
      borderPrimary: 'border-amber-500',
      buttonPrimary: 'bg-amber-600 hover:bg-amber-700 text-white',
      buttonSecondary: 'bg-amber-50 text-amber-700 hover:bg-amber-100',
      accent: 'bg-amber-100',
      icon: 'text-amber-700',
      highlight: 'ring-amber-500',
      sectionUser: 'border-stone-500',
      sectionBehavior: 'border-orange-400',
      sectionAcademic: 'border-emerald-600',
      sectionFuture: 'border-rose-400',
    }
  };

  // é è¨­è©•èªåº«
  const defaultData = {
    personality: [
      { id: 'p1', text: 'å€‹æ€§æº«å’Œæœ‰ç¦®', label: 'æº«å’Œæœ‰ç¦®' },
      { id: 'p2', text: 'å¤©æ€§æ¨‚è§€é–‹æœ—', label: 'æ¨‚è§€é–‹æœ—' },
      { id: 'p3', text: 'è¡Œäº‹ç©©é‡è¸å¯¦', label: 'ç©©é‡è¸å¯¦' },
      { id: 'p4', text: 'å¿ƒæ€ç´°è†©æ•æ„Ÿ', label: 'å¿ƒæ€ç´°è†©' },
      { id: 'p5', text: 'æ´»æ½‘å¤§æ–¹ï¼Œäººç·£æ¥µä½³', label: 'äººç·£å¥½' },
      { id: 'p6', text: 'å€‹æ€§æ¬éœï¼Œå–œæ„›é–±è®€', label: 'æ–‡éœæ„›é–±è®€' },
      { id: 'p7', text: 'å…·æœ‰é ˜å°ç‰¹è³ª', label: 'å…·é ˜å°åŠ›' },
      { id: 'p8', text: 'ç†±å¿ƒåŠ©äººï¼Œå¯ŒåŒæƒ…å¿ƒ', label: 'ç†±å¿ƒåŠ©äºº' },
      { id: 'p9', text: 'å€‹æ€§ç›´ç‡ï¼Œå‹‡æ–¼è¡¨é”', label: 'ç›´ç‡æ•¢è¨€' },
      { id: 'p10', text: 'å¯Œæœ‰å‰µé€ åŠ›ï¼Œé¬¼é»å­å¤š', label: 'å¯Œæœ‰å‰µæ„' },
    ],
    behavior: [
      { id: 'b_ex1', text: 'æ“”ä»»å¹¹éƒ¨è² è²¬ç›¡è·ï¼Œæ˜¯è€å¸«çš„å¥½å¹«æ‰‹', label: 'å¹¹éƒ¨è² è²¬', level: 'excellent' },
      { id: 'b_ex2', text: 'èˆ‡åŒå­¸ç›¸è™•èæ´½ï¼Œæ‡‚å¾—åˆ†äº«èˆ‡åˆä½œ', label: 'ç›¸è™•èæ´½', level: 'excellent' },
      { id: 'b_ex3', text: 'åšäº‹æ¢ç†åˆ†æ˜ï¼Œåº§ä½éš¨æ™‚ä¿æŒæ•´æ½”', label: 'æ„›æ•´æ½”', level: 'excellent' },
      { id: 'b_ex4', text: 'ä¸»å‹•å”åŠ©åŒå­¸ï¼Œå±•ç¾æœå‹™ç†±å¿±', label: 'æœå‹™ç†±å¿±', level: 'excellent' },
      { id: 'b_st1', text: 'èƒ½éµå®ˆç­ç´šè¦ç¯„ï¼Œå®‰åˆ†å®ˆå·±', label: 'å®ˆè¦çŸ©', level: 'stable' },
      { id: 'b_st2', text: 'æ‰“æƒå·¥ä½œèƒ½æŒ‰éƒ¨å°±ç­å®Œæˆ', label: 'æ‰“æƒç›¡è²¬', level: 'stable' },
      { id: 'b_st3', text: 'å°æ–¼äº¤è¾¦äº‹é …èƒ½åŠªåŠ›å®Œæˆ', label: 'ä½¿å‘½å¿…é”', level: 'stable' },
      { id: 'b_st4', text: 'é›–ç„¶è©±ä¸å¤šï¼Œä½†èƒ½é»˜é»˜å®Œæˆä»½å…§å·¥ä½œ', label: 'é»˜é»˜åšäº‹', level: 'stable' },
      { id: 'b_im1', text: 'æ´»æ½‘å¥è«‡ï¼Œè‹¥èƒ½å­¸ç¿’é…åˆå ´åˆç™¼è¨€æœƒæ›´æ£’', label: 'æ„›è¬›è©±(éœ€çœ‹å ´åˆ)', level: 'improve' },
      { id: 'b_im2', text: 'èˆ‡åŒå„•äº’å‹•æ™‚è‚¢é«”å‹•ä½œè¼ƒå¤§ï¼Œå»ºè­°å­¸ç¿’åˆå®œçš„ç¤¾äº¤è·é›¢', label: 'è‚¢é«”ç•Œç·š(éœ€å¼•å°)', level: 'improve' },
      { id: 'b_im3', text: 'æ³¨æ„åŠ›è¼ƒå®¹æ˜“ç™¼æ•£ï¼Œéœ€è€å¸«é©æ™‚æé†’å›æ­¸èª²å ‚', label: 'æ˜“åˆ†å¿ƒ(éœ€æé†’)', level: 'improve' },
      { id: 'b_im4', text: 'é‡åˆ°æŒ«æŠ˜æ™‚æƒ…ç·’èµ·ä¼è¼ƒæ˜é¡¯ï¼Œæ­£å­¸ç¿’åˆå®œçš„æŠ’ç™¼æ–¹å¼', label: 'æƒ…ç·’èµ·ä¼(å­¸ç¿’ä¸­)', level: 'improve' },
      { id: 'b_im5', text: 'éœ€åŠ å¼·æ™‚é–“è§€å¿µï¼Œè‹¥èƒ½æº–æ™‚å®Œæˆä»»å‹™æœƒæ›´å‡ºè‰²', label: 'åŠ å¼·å®ˆæ™‚', level: 'improve' },
      { id: 'b_im6', text: 'ç‰©å“ä¿ç®¡èƒ½åŠ›æœ‰é€²æ­¥ç©ºé–“ï¼Œå»ºè­°é¤Šæˆæ•´ç†å¥½ç¿’æ…£', label: 'æ•´ç†ç¿’æ…£', level: 'improve' },
    ],
    academic: [
      { id: 'a_chi1', text: 'åœ‹èªæ–‡ç†è§£èƒ½åŠ›ä½³ï¼Œèƒ½æµæš¢è¡¨é”æƒ³æ³•', label: 'åœ‹èªå„ªç•°', subject: 'chinese', level: 'excellent' },
      { id: 'a_chi2', text: 'ä½œæ–‡å…§å®¹å……å¯¦ï¼Œæƒ…æ„ŸçœŸæ‘¯ï¼Œç”¨è©è±å¯Œ', label: 'å¯«ä½œä½³', subject: 'chinese', level: 'excellent' },
      { id: 'a_chi3', text: 'å­—é«”å·¥æ•´ç¾è§€ï¼Œä½œæ¥­æ›¸å¯«ç›¸ç•¶ç”¨å¿ƒ', label: 'å­—é«”ç¾', subject: 'chinese', level: 'excellent' },
      { id: 'a_chi4', text: 'é–±è®€ç†è§£èƒ½åŠ›å°šæœ‰é€²æ­¥ç©ºé–“ï¼Œå»ºè­°å¤šé–±è®€çŸ­ç¯‡æ–‡ç« ', label: 'åŠ å¼·é–±è®€', subject: 'chinese', level: 'improve' },
      { id: 'a_chi5', text: 'å­—éŸ³å­—å½¢è¼ƒæ˜“æ··æ·†ï¼Œå»ºè­°å¤šåšè¾¨å­—ç·´ç¿’', label: 'åŠ å¼·å­—éŸ³å­—å½¢', subject: 'chinese', level: 'improve' },
      { id: 'a_math1', text: 'æ•¸ç†é‚è¼¯è§€å¿µæ¸…æ™°ï¼Œè§£é¡Œèƒ½åŠ›å¼·', label: 'æ•¸å­¸å„ªç•°', subject: 'math', level: 'excellent' },
      { id: 'a_math2', text: 'è¨ˆç®—é€Ÿåº¦å¿«ä¸”æ­£ç¢ºç‡é«˜', label: 'è¨ˆç®—ç²¾æº–', subject: 'math', level: 'excellent' },
      { id: 'a_math3', text: 'æ•¸å­¸åŸºç¤é‹ç®—å¹³ç©©ï¼Œèƒ½å®ŒæˆæŒ‡å®šç¿’é¡Œ', label: 'æ•¸å­¸å¹³ç©©', subject: 'math', level: 'stable' },
      { id: 'a_math4', text: 'æ‡‰ç”¨é¡Œæ„ç†è§£è¼ƒæ…¢ï¼Œå»ºè­°å¤šç·´ç¿’é¡Œç›®åˆ†æ', label: 'åŠ å¼·æ‡‰ç”¨é¡Œ', subject: 'math', level: 'improve' },
      { id: 'a_math5', text: 'è¨ˆç®—éç¨‹ç¨é¡¯æ€¥èºï¼Œè‹¥èƒ½ç´°å¿ƒæª¢æŸ¥æœƒæ›´å¥½', label: 'éœ€ç´°å¿ƒ', subject: 'math', level: 'improve' },
      { id: 'a_sci1', text: 'å…·å‚™ç§‘å­¸æ¢ç©¶ç²¾ç¥ï¼Œå–œæ„›å‹•æ‰‹æ“ä½œå¯¦é©—', label: 'ç§‘å­¸æ¢ç©¶', subject: 'science', level: 'excellent' },
      { id: 'a_soc1', text: 'å°æ–¼ç¤¾æœƒè­°é¡Œæœ‰ç¨åˆ°è¦‹è§£ï¼Œæ¨‚æ–¼åˆ†äº«', label: 'ç¤¾æœƒå¸¸è­˜ä½³', subject: 'science', level: 'excellent' },
      { id: 'a_art1', text: 'å…·å‚™è—è¡“å¤©åˆ†ï¼Œç¹ªç•«ä½œå“å……æ»¿ç«¥è¶£èˆ‡å‰µæ„', label: 'ç¹ªç•«å‰µæ„', subject: 'arts', level: 'excellent' },
      { id: 'a_pe1', text: 'é«”èƒ½è¡¨ç¾å„ªç•°ï¼Œç†±æ„›é‹å‹•ä¸”å…·åœ˜éšŠç²¾ç¥', label: 'é«”èƒ½ä½³', subject: 'arts', level: 'excellent' },
      { id: 'a_gen1', text: 'å­¸ç¿’æ…‹åº¦ç©æ¥µä¸»å‹•', label: 'æ…‹åº¦ç©æ¥µ', subject: 'general', level: 'excellent' },
      { id: 'a_gen2', text: 'ä¸Šèª²å°ˆæ³¨åŠ›é›†ä¸­ï¼Œèƒ½æŒæ¡å­¸ç¿’é‡é»', label: 'ä¸Šèª²å°ˆæ³¨', subject: 'general', level: 'excellent' },
      { id: 'a_gen3', text: 'å°æ–¼ä¸æ‡‚çš„å•é¡Œèƒ½ä¸»å‹•æå•', label: 'ä¸»å‹•ç™¼å•', subject: 'general', level: 'excellent' },
      { id: 'a_gen4', text: 'ä½œæ¥­ç¹³äº¤æƒ…å½¢è‰¯å¥½ï¼Œå­¸ç¿’ç‹€æ³ç©©å®š', label: 'æŒ‰æ™‚äº¤ä½œæ¥­', subject: 'general', level: 'stable' },
    ],
    future: [
      { id: 'f1', text: 'æœŸè¨±ä¸‹å­¸æœŸèƒ½ä¿æŒå„ªé»ï¼Œç¹¼çºŒç™¼å…‰ç™¼ç†±ã€‚', label: 'ä¿æŒå„ªé»' },
      { id: 'f2', text: 'è€å¸«ç›¸ä¿¡ä½ åªè¦å¤šä¸€ä»½ç´°å¿ƒï¼Œè¡¨ç¾æœƒæ›´å‡ºè‰²ã€‚', label: 'å¤šä»½ç´°å¿ƒ' },
      { id: 'f3', text: 'æœŸå¾…æœªä¾†èƒ½çœ‹åˆ°ä½ å±•ç¾æ›´å¤šçš„è‡ªä¿¡ã€‚', label: 'å±•ç¾è‡ªä¿¡' },
      { id: 'f4', text: 'é¡˜ä½ æŒçºŒä¿æœ‰é–±è®€çš„å¥½ç¿’æ…£ï¼Œé–‹æ‹“æ›´å¯¬å»£çš„è¦–é‡ã€‚', label: 'æŒçºŒé–±è®€' },
      { id: 'f5', text: 'æœŸç›¼ä½ åœ¨æ–°çš„å­¸æœŸèƒ½è¨­å®šç›®æ¨™ï¼Œå‹‡å¾€ç›´å‰ã€‚', label: 'è¨­å®šç›®æ¨™' },
      { id: 'f6', text: 'å¸Œæœ›ä½ èƒ½å­¸ç¿’æ§åˆ¶æƒ…ç·’ï¼Œè®“è‡ªå·±æˆç‚ºæƒ…ç·’çš„ä¸»äººã€‚', label: 'æƒ…ç·’ç®¡ç†(æœŸè¨±)' },
      { id: 'f7', text: 'åªè¦é¡˜æ„ä»˜å‡ºåŠªåŠ›ï¼Œè€å¸«ç›¸ä¿¡ä½ ä¸€å®šæœƒé€²æ­¥ã€‚', label: 'é¼“å‹µé€²æ­¥' },
    ]
  };

  // --- åˆå§‹åŒ–ç‹€æ…‹ ---
  const createDefaultStudents = () => {
    return Array.from({ length: DEFAULT_STUDENT_COUNT }, (_, i) => ({
      id: i + 1,
      name: '',
      personality: [],
      behavior: [],
      academic: [],
      future: [],
      generatedComment: '',
      isPolished: false,
      // Updated grades structure to include physics, biology, history, geography, integrated
      grades: { 
        chinese: '', math: '', science: '', social: '', arts: '', dailyAvg: '', examAvg: '',
        physics: '', biology: '', history: '', geography: '', integrated: ''
      }
    }));
  };

  const [students, setStudents] = useState(createDefaultStudents());
  const [customData, setCustomData] = useState({ personality: [], behavior: [], academic: [], future: [] });
  const [currentStudentId, setCurrentStudentId] = useState(1);
  const [isAiLoading, setIsAiLoading] = useState(false);
  const [isCopied, setIsCopied] = useState(false);
  const [showSidebar, setShowSidebar] = useState(true);
  const [currentTheme, setCurrentTheme] = useState('warm'); 
  const [aiTone, setAiTone] = useState('warm'); 
  
  // Modals & Confirmation
  const [showCustomModal, setShowCustomModal] = useState(false);
  const [showHelpModal, setShowHelpModal] = useState(false);
  const [customCategory, setCustomCategory] = useState('');
  const [newCustomLabel, setNewCustomLabel] = useState('');
  const [newCustomText, setNewCustomText] = useState('');
  const fileInputRef = useRef(null);
  const configInputRef = useRef(null); 

  const [confirmConfig, setConfirmConfig] = useState({ show: false, title: '', message: '', onConfirm: null });

  const t = themes[currentTheme]; 

  const currentStudent = students.find(s => s.id === currentStudentId) || students[0];

  // --- ç”Ÿå‘½é€±æœŸèˆ‡å„²å­˜ ---
  useEffect(() => {
    const savedData = localStorage.getItem(STORAGE_KEY);
    const savedCustom = localStorage.getItem(CUSTOM_DATA_KEY);
    const savedTheme = localStorage.getItem('comment_generator_theme');
    
    if (savedData) {
      try { 
        const parsed = JSON.parse(savedData); 
        if (Array.isArray(parsed)) {
          // Merge with default structure to ensure new fields exist for old data
          const migrated = parsed.map(s => ({
            ...s,
            grades: {
              chinese: '', math: '', science: '', social: '', arts: '', dailyAvg: '', examAvg: '',
              physics: '', biology: '', history: '', geography: '', integrated: '',
              ...s.grades // overwrite with saved data
            }
          }));
          setStudents(migrated); 
        }
      } catch (e) { console.error("Failed to load students", e); }
    }
    if (savedCustom) {
      try { const parsed = JSON.parse(savedCustom); if (parsed && typeof parsed === 'object') setCustomData(parsed); } 
      catch (e) { console.error("Failed to load custom data", e); }
    }
    if (savedTheme && themes[savedTheme]) {
      setCurrentTheme(savedTheme);
    }
  }, []);

  useEffect(() => localStorage.setItem(STORAGE_KEY, JSON.stringify(students)), [students]);
  useEffect(() => localStorage.setItem(CUSTOM_DATA_KEY, JSON.stringify(customData)), [customData]);
  useEffect(() => localStorage.setItem('comment_generator_theme', currentTheme), [currentTheme]);

  // --- Helper: Confirmation Dialog Trigger ---
  const triggerConfirm = (title, message, onConfirm) => {
    setConfirmConfig({ show: true, title, message, onConfirm });
  };
  
  const handleConfirmAction = () => {
    if (confirmConfig.onConfirm) confirmConfig.onConfirm();
    setConfirmConfig({ ...confirmConfig, show: false });
  };

  // --- é‚è¼¯è™•ç† ---
  const updateStudent = (id, field, value) => {
    setStudents(prev => prev.map(s => s.id === id ? { ...s, [field]: value, isPolished: field === 'generatedComment' ? s.isPolished : false } : s));
  };
  
  const updateGrade = (id, subject, value) => {
    setStudents(prev => prev.map(s => {
      if (s.id === id) {
        return { ...s, grades: { ...s.grades, [subject]: value }, isPolished: false };
      }
      return s;
    }));
  };

  const handleSelection = (category, item) => {
    const currentList = currentStudent[category];
    let newList = currentList.some(i => i.id === item.id) ? currentList.filter(i => i.id !== item.id) : [...currentList, item];
    
    setStudents(prev => prev.map(s => {
      if (s.id === currentStudentId) {
        const updatedStudent = { ...s, [category]: newList };
        const newComment = generateCommentText(updatedStudent);
        return { ...updatedStudent, generatedComment: newComment, isPolished: false };
      }
      return s;
    }));
  };

  const handleNameChange = (e) => {
    const newName = e.target.value;
    setStudents(prev => prev.map(s => {
      if (s.id === currentStudentId) {
        const updatedStudent = { ...s, name: newName };
        const newComment = generateCommentText(updatedStudent);
        return { ...updatedStudent, generatedComment: newComment, isPolished: false };
      }
      return s;
    }));
  };

  const generateCommentText = (student) => {
    const name = student.name.trim() || 'è©²ç”Ÿ';
    let parts = [];
    parts.push(`${name}åœ¨æ ¡æœŸé–“`);
    if (student.personality.length > 0) parts.push(student.personality.map(i => i.text).join('ï¼Œ') + 'ã€‚');
    if (student.behavior.length > 0) parts.push('åœ¨æ—¥å¸¸ç”Ÿæ´»æ–¹é¢ï¼Œ' + student.behavior.map(i => i.text).join('ï¼›') + 'ã€‚');
    if (student.academic.length > 0) parts.push('å­¸ç¿’è¡¨ç¾ä¸Šï¼Œ' + student.academic.map(i => i.text).join('ï¼Œ') + 'ã€‚');
    if (student.future.length > 0) parts.push(student.future.map(i => i.text).join(''));
    return parts.join('');
  };

  // --- CSV åŒ¯å…¥èˆ‡ç¯„æœ¬ä¸‹è¼‰ ---
  const handleDownloadTemplate = () => {
    const BOM = "\uFEFF";
    const content = "åº§è™Ÿ,å§“å,åœ‹èª,æ•¸å­¸,è‡ªç„¶,ç¤¾æœƒ,è‹±æ–‡,è—æ–‡,å¥é«”,ç¶œåˆ,ç†åŒ–,ç”Ÿç‰©,æ­·å²,åœ°ç†\n1,ç‹å°æ˜,90,85,88,92,80,89,88,85,85,90,88,92\n2,æå°è¯,85,90,82,88,95,88,89,90,80,85,90,85";
    const blob = new Blob([BOM + content], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = "å­¸ç”Ÿåå–®åŒ¯å…¥ç¯„æœ¬_V1.0.csv";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const handleImportCSV = (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (event) => {
      const text = event.target.result;
      const rows = text.split('\n').map(row => row.trim()).filter(row => row);
      
      triggerConfirm(
        'ç¢ºèªåŒ¯å…¥è³‡æ–™',
        `å³å°‡åŒ¯å…¥ ${rows.length > 0 ? rows.length - 1 : 0} ç­†è³‡æ–™ã€‚\nè«‹ç¢ºèª CSV æ ¼å¼åŒ…å«ï¼šå§“å,åœ‹èª,æ•¸å­¸,è‡ªç„¶,ç¤¾æœƒ,è‹±æ–‡,è—æ–‡,å¥é«”,ç¶œåˆ,ç†åŒ–,ç”Ÿç‰©,æ­·å²,åœ°ç†ã€‚\næ³¨æ„ï¼šé€™å°‡è¦†è“‹ç¾æœ‰çš„åŒåº§è™Ÿå­¸ç”Ÿè³‡æ–™ã€‚`,
        () => {
          const newStudents = [...students];
          for (let i = 1; i < rows.length; i++) {
            if (i > DEFAULT_STUDENT_COUNT) break; 
            const cols = rows[i].split(',').map(c => c.replace(/^"|"$/g, '').trim());
            const targetIndex = i - 1; 
            if (targetIndex < newStudents.length) {
              let nameIdx = 0;
              if (!isNaN(parseInt(cols[0]))) nameIdx = 1;
              if (cols[nameIdx]) newStudents[targetIndex].name = cols[nameIdx];
              // Mapping based on new template order
              if (cols[nameIdx+1]) newStudents[targetIndex].grades.chinese = cols[nameIdx+1];
              if (cols[nameIdx+2]) newStudents[targetIndex].grades.math = cols[nameIdx+2];
              if (cols[nameIdx+3]) newStudents[targetIndex].grades.science = cols[nameIdx+3];
              if (cols[nameIdx+4]) newStudents[targetIndex].grades.social = cols[nameIdx+4];
              if (cols[nameIdx+5]) newStudents[targetIndex].grades.arts = cols[nameIdx+5]; // è‹±æ–‡
              if (cols[nameIdx+6]) newStudents[targetIndex].grades.dailyAvg = cols[nameIdx+6]; // è—æ–‡
              if (cols[nameIdx+7]) newStudents[targetIndex].grades.examAvg = cols[nameIdx+7]; // å¥é«”
              if (cols[nameIdx+8]) newStudents[targetIndex].grades.integrated = cols[nameIdx+8]; // ç¶œåˆ
              if (cols[nameIdx+9]) newStudents[targetIndex].grades.physics = cols[nameIdx+9]; // ç†åŒ–
              if (cols[nameIdx+10]) newStudents[targetIndex].grades.biology = cols[nameIdx+10]; // ç”Ÿç‰©
              if (cols[nameIdx+11]) newStudents[targetIndex].grades.history = cols[nameIdx+11]; // æ­·å²
              if (cols[nameIdx+12]) newStudents[targetIndex].grades.geography = cols[nameIdx+12]; // åœ°ç†

              newStudents[targetIndex].generatedComment = generateCommentText(newStudents[targetIndex]);
              newStudents[targetIndex].isPolished = false;
            }
          }
          setStudents(newStudents);
          alert('åŒ¯å…¥å®Œæˆï¼è«‹æª¢æŸ¥å·¦å´åå–®ã€‚');
        }
      );
    };
    reader.readAsText(file);
    e.target.value = '';
  };

  const handleExportConfig = () => {
    const config = {
      version: 'v1.0',
      timestamp: new Date().toISOString(),
      students: students,
      customData: customData
    };
    const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `è©•èªç”Ÿæˆå™¨_å‚™ä»½_${new Date().toISOString().slice(0, 10)}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const handleImportConfig = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (event) => {
      try {
        const parsed = JSON.parse(event.target.result);
        if (parsed.students && Array.isArray(parsed.students) && parsed.customData) {
           triggerConfirm(
             'ç¢ºèªé‚„åŸå‚™ä»½',
             'å³å°‡åŒ¯å…¥å‚™ä»½æª”ã€‚é€™å°‡æœƒè¦†è“‹ç›®å‰çš„å­¸ç”Ÿè³‡æ–™èˆ‡è‡ªè¨‚é‡‘å¥ã€‚ç¢ºå®šè¦åŸ·è¡Œå—ï¼Ÿ',
             () => {
               setStudents(parsed.students);
               setCustomData(parsed.customData);
               alert('è¨­å®šæª”é‚„åŸæˆåŠŸï¼');
             }
           );
        } else {
          alert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¢ºèªæ˜¯å¦ç‚ºæ­£ç¢ºçš„å‚™ä»½æª” (.json)ã€‚');
        }
      } catch (err) {
        console.error(err);
        alert('è®€å–æª”æ¡ˆå¤±æ•—');
      }
    };
    reader.readAsText(file);
    e.target.value = '';
  };

  const toggleTheme = () => {
    setCurrentTheme(prev => prev === 'blue' ? 'warm' : 'blue');
  };

  const handleAiPolish = async () => {
    if (!currentStudent.generatedComment || currentStudent.generatedComment.length < 5) { alert("è«‹å…ˆç”¢ç”Ÿæˆ–è¼¸å…¥ä¸€äº›è©•èªå…§å®¹å¾Œå†é€²è¡Œæ½¤é£¾ã€‚"); return; }
    setIsAiLoading(true);
    try {
      const g = currentStudent.grades;
      const gradesInfo = [
        g.chinese && `åœ‹èª:${g.chinese}`, 
        g.math && `æ•¸å­¸:${g.math}`, 
        g.science && `è‡ªç„¶:${g.science}`, 
        g.social && `ç¤¾æœƒ:${g.social}`, 
        g.arts && `è‹±æ–‡:${g.arts}`,
        g.physics && `ç†åŒ–:${g.physics}`,
        g.biology && `ç”Ÿç‰©:${g.biology}`,
        g.history && `æ­·å²:${g.history}`,
        g.geography && `åœ°ç†:${g.geography}`,
        g.dailyAvg && `è—æ–‡:${g.dailyAvg}`,
        g.examAvg && `å¥é«”:${g.examAvg}`,
        g.integrated && `ç¶œåˆ:${g.integrated}`
      ].filter(Boolean).join(', ');
      
      let toneInstruction = "";
      if (aiTone === 'warm') {
        toneInstruction = "èªæ°£é¢¨æ ¼è¦æ±‚ï¼šæº«æŸ”è¦ªåˆ‡ã€å……æ»¿æ­£å‘é¼“å‹µã€å¤šç”¨æ„›å¿ƒèˆ‡æœŸè¨±çš„å£å»ï¼Œè®“å®¶é•·å’Œå­¸ç”Ÿæ„Ÿåˆ°æº«æš–èˆ‡è¢«æ”¯æŒã€‚";
      } else {
        toneInstruction = "èªæ°£é¢¨æ ¼è¦æ±‚ï¼šåš´è¬¹å®¢è§€ã€å°ˆæ¥­ç°¡æ½”ã€å…·é«”é™³è¿°äº‹å¯¦èˆ‡å»ºè­°ï¼Œå±•ç¾æ•™è‚²å°ˆæ¥­åº¦ï¼Œé¿å…éå¤šæƒ…ç·’ä¿®é£¾ã€‚";
      }

      const prompt = `ä½ æ˜¯ä¸€ä½åœ‹æ°‘å°å­¸/åœ‹ä¸­è€å¸«ã€‚è«‹å”åŠ©æ½¤é£¾ä»¥ä¸‹æœŸæœ«è©•èªã€‚
      
      **å­¸ç”Ÿè³‡è¨Š**ï¼š
      å­¸ç”Ÿå§“åï¼š${currentStudent.name || 'è©²ç”Ÿ'}
      æˆç¸¾åƒè€ƒï¼š${gradesInfo} (è‹¥æˆç¸¾å„ªç•°è«‹é©åº¦è®šç¾ï¼Œè‹¥è½å¾Œè«‹å§”å©‰å»ºè­°)
      
      **åŸå§‹è©•èªè‰ç¨¿**ï¼š
      "${currentStudent.generatedComment}"
      
      **æ½¤é£¾è¦æ±‚**ï¼š
      1. ${toneInstruction}
      2. ä¿æŒåŸæ„ï¼Œæ•´åˆå­¸æ¥­æˆç¸¾èˆ‡æ—¥å¸¸è¡Œç‚ºè¡¨ç¾ã€‚
      3. æ¶ˆé™¤æ©Ÿæ¢°æ‹¼æ¥æ„Ÿï¼Œè®“æ–‡ç« æµæš¢è‡ªç„¶ã€‚
      4. ç›´æ¥è¼¸å‡ºæ½¤é£¾å¾Œçš„å…§å®¹å³å¯ï¼Œä¸è¦æœ‰é–‹å ´ç™½ã€‚`;
      
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
      });
      const result = await response.json();
      const polishedText = result.candidates?.[0]?.content?.parts?.[0]?.text;
      if (polishedText) { updateStudent(currentStudentId, 'generatedComment', polishedText); updateStudent(currentStudentId, 'isPolished', true); }
    } catch (error) { console.error(error); alert("AI é€£ç·šéŒ¯èª¤"); } finally { setIsAiLoading(false); }
  };

  const handleExportCSV = () => {
    const BOM = "\uFEFF"; 
    const headers = "åº§è™Ÿ,å§“å,åœ‹èª,æ•¸å­¸,è‡ªç„¶,ç¤¾æœƒ,è‹±æ–‡,è—æ–‡,å¥é«”,ç¶œåˆ,ç†åŒ–,ç”Ÿç‰©,æ­·å²,åœ°ç†,è©•èª\n";
    const rows = students.map(s => { 
      const g = s.grades; 
      const c = (s.generatedComment || '').replace(/"/g, '""'); 
      return `${s.id},"${s.name}",${g.chinese},${g.math},${g.science},${g.social},${g.arts},${g.dailyAvg},${g.examAvg},${g.integrated},${g.physics},${g.biology},${g.history},${g.geography},"${c}"`; 
    }).join("\n");
    const blob = new Blob([BOM + headers + rows], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `è©•èªè¡¨.csv`; document.body.appendChild(link); link.click(); document.body.removeChild(link);
  };

  const handleClearAllData = () => { 
    triggerConfirm(
      'ç¢ºèªæ¸…ç©ºæ‰€æœ‰è³‡æ–™', 
      'ç¢ºå®šè¦æ¸…ç©ºå…¨ç­ 40 ä½å­¸ç”Ÿçš„æ‰€æœ‰è³‡æ–™ï¼ˆå«æˆç¸¾èˆ‡è©•èªï¼‰å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚', 
      () => {
        setStudents(createDefaultStudents()); 
        localStorage.removeItem(STORAGE_KEY); 
      }
    );
  };
  
  const handleClearCurrentStudent = () => {
    triggerConfirm(
      'ç¢ºèªæ¸…é™¤æœ¬ç”Ÿè³‡æ–™',
      `ç¢ºå®šè¦æ¸…ç©º ${currentStudent.name || 'é€™ä½å­¸ç”Ÿ'} (åº§è™Ÿ ${currentStudent.id}) çš„æ‰€æœ‰è³‡æ–™å—ï¼Ÿ\næ­¤å‹•ä½œå°‡æ¸…é™¤å§“åã€æˆç¸¾ã€é¸é …èˆ‡è©•èªã€‚`,
      () => {
        setStudents(prev => prev.map(s => {
          if (s.id === currentStudentId) {
            return {
              id: s.id, 
              name: '',
              personality: [],
              behavior: [],
              academic: [],
              future: [],
              generatedComment: '',
              isPolished: false,
              grades: { chinese: '', math: '', science: '', social: '', arts: '', dailyAvg: '', examAvg: '', physics: '', biology: '', history: '', geography: '', integrated: '' }
            };
          }
          return s;
        }));
      }
    );
  };

  const copyToClipboard = () => {
    const textArea = document.createElement("textarea"); textArea.value = currentStudent.generatedComment; document.body.appendChild(textArea); textArea.select();
    try { if (document.execCommand('copy')) { setIsCopied(true); setTimeout(() => setIsCopied(false), 2000); } } catch (err) {}
    document.body.removeChild(textArea);
  };

  const openCustomModal = (category) => { setCustomCategory(category); setNewCustomLabel(''); setNewCustomText(''); setShowCustomModal(true); };
  const saveCustomOption = () => { if (!newCustomLabel || !newCustomText) return; setCustomData(prev => ({...prev, [customCategory]: [...(prev[customCategory]||[]), {id:`custom_${Date.now()}`, text:newCustomText, label:newCustomLabel, level:'stable', subject:'general'}]})); setShowCustomModal(false); };
  const deleteCustomOption = (cat, id) => { 
    triggerConfirm("åˆªé™¤è‡ªè¨‚é¸é …", "ç¢ºå®šè¦åˆªé™¤é€™å€‹è‡ªè¨‚èªå¥å—ï¼Ÿ", () => {
      setCustomData(prev => ({...prev, [cat]: prev[cat].filter(i => i.id !== id)})); 
    });
  };

  return (
    <div className={`flex h-screen ${t.bgMain} font-sans ${t.textPrimary} overflow-hidden transition-colors duration-300`}>
      <style>{`
        @media print {
          .no-print { display: none !important; }
          .print-only { display: block !important; }
          .print-area { width: 100% !important; height: auto !important; border: none !important; box-shadow: none !important; }
          textarea { border: none !important; resize: none !important; height: auto !important; overflow: visible !important; }
          body { background: white !important; }
        }
      `}</style>

      {/* éš±è—çš„æª”æ¡ˆè¼¸å…¥ */}
      <input type="file" ref={fileInputRef} onChange={handleImportCSV} accept=".csv" className="hidden" />
      <input type="file" ref={configInputRef} onChange={handleImportConfig} accept=".json" className="hidden" />

      {/* å·¦å´é‚Šæ¬„ */}
      <div className={`${showSidebar ? 'w-64 translate-x-0' : 'w-0 -translate-x-full lg:w-64 lg:translate-x-0'} absolute lg:static z-30 h-full ${t.bgSidebar} border-r border-gray-200 flex flex-col transition-all duration-300 shadow-2xl lg:shadow-none no-print`}>
        <div className={`p-4 border-b border-gray-200 flex items-center justify-between ${t.accent}`}>
          <h2 className={`font-bold ${t.textPrimary} flex items-center gap-2`}><Users className="w-5 h-5" /> ç­ç´šåå–®</h2>
          <button onClick={() => setShowSidebar(false)} className="lg:hidden text-gray-500 p-2"><RotateCcw className="w-4 h-4" /></button>
        </div>
        <div className="flex-1 overflow-y-auto p-2 space-y-1">
          {students.map((s) => (
            <button key={s.id} onClick={() => { setCurrentStudentId(s.id); if(window.innerWidth < 1024) setShowSidebar(false); }} className={`w-full flex items-center p-3 rounded-lg text-left transition-all ${currentStudentId === s.id ? `${t.buttonPrimary} shadow-md` : `hover:bg-gray-100 ${t.textSecondary}`}`}>
              <div className={`w-2 h-full absolute left-0 top-0 rounded-l-lg ${s.generatedComment ? 'bg-green-400' : 'bg-transparent'}`}></div>
              <span className={`w-6 h-6 flex items-center justify-center rounded-full text-xs mr-3 flex-shrink-0 ${currentStudentId === s.id ? 'bg-white/20 text-white' : 'bg-gray-200 text-gray-600'}`}>{s.id}</span>
              <div className="flex flex-col overflow-hidden"><span className="font-medium truncate">{s.name || `åº§è™Ÿ ${s.id}`}</span></div>
            </button>
          ))}
        </div>
        <div className="p-3 border-t border-gray-200 space-y-2 bg-gray-50/50">
          <div className="flex gap-2">
             <button onClick={() => fileInputRef.current.click()} className="flex-1 flex items-center justify-center gap-1 px-2 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 text-xs"><Upload className="w-3 h-3" /> åŒ¯å…¥ CSV</button>
             <button onClick={handleDownloadTemplate} className="flex-1 flex items-center justify-center gap-1 px-2 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 text-xs"><FileDown className="w-3 h-3" /> ä¸‹è¼‰ç¯„æœ¬</button>
          </div>
          <button onClick={handleExportCSV} className="w-full flex items-center justify-center gap-2 px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700 text-xs font-bold"><FileSpreadsheet className="w-4 h-4" /> åŒ¯å‡ºè©•èª CSV</button>
          
          {/* è·¨æ©ŸåŒæ­¥å€å¡Š */}
          <div className="pt-2 mt-2 border-t border-gray-200">
            <div className="text-[10px] text-gray-400 text-center mb-1">è·¨æ©ŸåŒæ­¥ / å‚™ä»½</div>
            <div className="flex gap-2">
              <button onClick={handleExportConfig} className="flex-1 flex items-center justify-center gap-1 px-2 py-2 bg-amber-500 text-white rounded hover:bg-amber-600 text-xs" title="åŒ¯å‡ºè¨­å®šæª”(.json)"><DownloadCloud className="w-3 h-3" /> åŒ¯å‡ºå‚™ä»½</button>
              <button onClick={() => configInputRef.current.click()} className="flex-1 flex items-center justify-center gap-1 px-2 py-2 bg-slate-500 text-white rounded hover:bg-slate-600 text-xs" title="åŒ¯å…¥è¨­å®šæª”(.json)"><UploadCloud className="w-3 h-3" /> åŒ¯å…¥å‚™ä»½</button>
            </div>
          </div>
        </div>
      </div>

      {/* ä¸»å…§å®¹å€ */}
      <div className="flex-1 flex flex-col h-screen overflow-hidden relative w-full">
        {showSidebar && <div className="fixed inset-0 bg-black/20 z-20 lg:hidden no-print" onClick={() => setShowSidebar(false)}></div>}

        {/* Header */}
        <header className={`${t.bgHeader} border-b border-gray-200 px-4 py-3 md:px-6 md:py-4 flex items-center justify-between flex-shrink-0 no-print`}>
          <div className="flex items-center gap-4">
             <button onClick={() => setShowSidebar(!showSidebar)} className="lg:hidden p-2 -ml-2 rounded-full hover:bg-gray-100 text-gray-600"><Users className="w-6 h-6" /></button>
             <PenTool className={`w-8 h-8 ${t.icon} hidden md:block`} />
             <div>
               <h1 className={`text-2xl md:text-3xl font-bold ${t.textPrimary} flex items-center flex-wrap gap-2`}>
                 å­¸ç”ŸæœŸæœ«è©•èªæ’°å¯«~AIç¥åŠ©æ•™ <span className="text-xs md:text-sm bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full align-middle font-normal">V1.0ç‰ˆ</span>
               </h1>
               <div className={`text-sm md:text-base ${t.textSecondary} font-medium mt-1`}>è‡ºä¸­å¸‚åœ‹æ•™è¼”å°åœ˜è³‡è¨Šæ•™è‚²è­°é¡Œè¼”å°å“¡ æ˜Œå’Œè€å¸«</div>
             </div>
          </div>
          <div className="flex items-center gap-2">
            <button onClick={toggleTheme} className="p-2 rounded-full hover:bg-gray-100 text-gray-500" title={currentTheme === 'blue' ? 'åˆ‡æ›æš–è‰²æ¨¡å¼' : 'åˆ‡æ›å°ˆæ¥­æ¨¡å¼'}>
              {currentTheme === 'blue' ? <Sun className="w-5 h-5" /> : <Moon className="w-5 h-5" />}
            </button>
            <button onClick={() => setShowHelpModal(true)} className="p-2 rounded-full hover:bg-gray-100 text-gray-500" title="ä½¿ç”¨èªªæ˜"><HelpCircle className="w-6 h-6" /></button>
          </div>
        </header>

        <div className="flex-1 overflow-hidden flex flex-col lg:flex-row">
          
          {/* é¸é …å€ */}
          <div className="flex-1 overflow-y-auto p-4 md:p-6 pb-24 lg:pb-6 scroll-smooth no-print">
            <div className="max-w-3xl mx-auto space-y-4">
              <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                <div className="flex items-center gap-2 mb-4">
                  <label className="font-bold text-gray-700 whitespace-nowrap">å­¸ç”Ÿå§“åï¼š</label>
                  <input type="text" value={currentStudent.name} onChange={handleNameChange} placeholder="è«‹è¼¸å…¥" className="flex-1 px-4 py-2 border rounded focus:ring-2 outline-none" />
                  <button 
                    onClick={handleClearCurrentStudent}
                    className="flex items-center gap-1 px-3 py-2 text-red-600 bg-red-50 hover:bg-red-100 rounded transition-colors text-sm whitespace-nowrap font-medium"
                    title="æ¸…ç©ºé€™ä½å­¸ç”Ÿçš„æ‰€æœ‰è³‡æ–™"
                  >
                    <Eraser className="w-4 h-4" /> æ¸…é™¤é‡ç½®
                  </button>
                </div>
                <div className="border-t border-gray-100 pt-4">
                  <h3 className="text-sm font-bold text-gray-600 mb-3 flex items-center gap-2"><GraduationCap className="w-4 h-4" /> å­¸ç§‘ç¸½æˆç¸¾ (é¸å¡«ï¼Œä¾›AIåƒè€ƒæ’°å¯«è©•èª)</h3>
                  <div className="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3">
                    <GradeInput label="åœ‹èª" value={currentStudent.grades.chinese} onChange={v => updateGrade(currentStudentId, 'chinese', v)} themeStyles={t} />
                    <GradeInput label="æ•¸å­¸" value={currentStudent.grades.math} onChange={v => updateGrade(currentStudentId, 'math', v)} themeStyles={t} />
                    <GradeInput label="è‡ªç„¶" value={currentStudent.grades.science} onChange={v => updateGrade(currentStudentId, 'science', v)} themeStyles={t} />
                    <GradeInput label="ç¤¾æœƒ" value={currentStudent.grades.social} onChange={v => updateGrade(currentStudentId, 'social', v)} themeStyles={t} />
                    <GradeInput label="è‹±æ–‡" value={currentStudent.grades.arts} onChange={v => updateGrade(currentStudentId, 'arts', v)} themeStyles={t} />
                    <GradeInput label="è—æ–‡" value={currentStudent.grades.dailyAvg} onChange={v => updateGrade(currentStudentId, 'dailyAvg', v)} themeStyles={t} />
                    <GradeInput label="å¥é«”" value={currentStudent.grades.examAvg} onChange={v => updateGrade(currentStudentId, 'examAvg', v)} themeStyles={t} />
                    <GradeInput label="ç¶œåˆ" value={currentStudent.grades.integrated} onChange={v => updateGrade(currentStudentId, 'integrated', v)} themeStyles={t} />
                    <GradeInput label="ç†åŒ–" value={currentStudent.grades.physics} onChange={v => updateGrade(currentStudentId, 'physics', v)} themeStyles={t} />
                    <GradeInput label="ç”Ÿç‰©" value={currentStudent.grades.biology} onChange={v => updateGrade(currentStudentId, 'biology', v)} themeStyles={t} />
                    <GradeInput label="æ­·å²" value={currentStudent.grades.history} onChange={v => updateGrade(currentStudentId, 'history', v)} themeStyles={t} />
                    <GradeInput label="åœ°ç†" value={currentStudent.grades.geography} onChange={v => updateGrade(currentStudentId, 'geography', v)} themeStyles={t} />
                  </div>
                </div>
              </div>
              <SelectionSection title="äººæ ¼ç‰¹è³ª" icon={User} defaultItems={defaultData.personality} customItems={customData.personality} selectedItems={currentStudent.personality} category="personality" colorBorder={t.sectionUser} onSelection={handleSelection} onOpenCustom={openCustomModal} onDeleteCustom={deleteCustomOption} themeStyles={t} />
              <SelectionSection title="ç”Ÿæ´»è¡¨ç¾" icon={Star} defaultItems={defaultData.behavior} customItems={customData.behavior} selectedItems={currentStudent.behavior} category="behavior" colorBorder={t.sectionBehavior} hasLevelFilter={true} onSelection={handleSelection} onOpenCustom={openCustomModal} onDeleteCustom={deleteCustomOption} themeStyles={t} />
              <SelectionSection title="å­¸ç§‘èƒ½åŠ›" icon={BookOpen} defaultItems={defaultData.academic} customItems={customData.academic} selectedItems={currentStudent.academic} category="academic" colorBorder={t.sectionAcademic} hasLevelFilter={true} hasSubjectFilter={true} onSelection={handleSelection} onOpenCustom={openCustomModal} onDeleteCustom={deleteCustomOption} themeStyles={t} />
              <SelectionSection title="è€å¸«æœŸè¨±" icon={Sparkles} defaultItems={defaultData.future} customItems={customData.future} selectedItems={currentStudent.future} category="future" colorBorder={t.sectionFuture} onSelection={handleSelection} onOpenCustom={openCustomModal} onDeleteCustom={deleteCustomOption} themeStyles={t} />
            </div>
          </div>

          {/* é è¦½å€ */}
          <div className={`lg:w-1/3 ${t.bgSidebar} border-t lg:border-t-0 lg:border-l border-gray-200 flex flex-col h-[40vh] lg:h-full shadow-2xl lg:shadow-xl z-20 print-area relative`}>
            <div className="p-3 md:p-4 bg-white border-b border-gray-200 flex flex-col sm:flex-row justify-between items-center no-print gap-2">
               <h2 className="font-bold text-gray-800 flex items-center gap-2"><CheckCircle2 className={`w-5 h-5 ${t.icon}`} /> è©•èªé è¦½</h2>
               <div className="flex items-center gap-2">
                 <select 
                   value={aiTone} 
                   onChange={(e) => setAiTone(e.target.value)}
                   className="text-xs border border-gray-300 rounded-md px-2 py-1.5 bg-white focus:outline-none focus:ring-2 focus:ring-purple-200 text-gray-600 cursor-pointer hover:bg-gray-50"
                   title="é¸æ“‡ AI æ½¤é£¾çš„èªæ°£é¢¨æ ¼"
                 >
                   <option value="warm">â¤ï¸ æº«æŸ”é¼“å‹µ</option>
                   <option value="professional">ğŸ“ åš´è¬¹å°ˆæ¥­</option>
                 </select>

                 <button onClick={handleAiPolish} disabled={isAiLoading} className={`flex items-center gap-1 px-3 py-1.5 rounded-full text-xs font-medium transition-all whitespace-nowrap ${isAiLoading ? 'bg-gray-100 text-gray-400' : 'bg-purple-100 text-purple-700 hover:bg-purple-200'}`}>
                   <Wand2 className={`w-3 h-3 ${isAiLoading ? 'animate-spin' : ''}`} /> {isAiLoading ? 'AI æ’°å¯«ä¸­...' : 'AI æ½¤é£¾'}
                 </button>
               </div>
            </div>
            
            <div className="flex-1 p-4 overflow-y-auto print-area relative">
               <textarea
                value={currentStudent.generatedComment}
                onChange={(e) => updateStudent(currentStudentId, 'generatedComment', e.target.value)}
                className={`w-full h-full min-h-[150px] p-4 pb-8 border rounded-xl bg-white focus:ring-2 transition-all resize-none text-base md:text-lg leading-relaxed text-gray-700 outline-none ${currentStudent.isPolished ? 'border-purple-300 ring-2 ring-purple-100' : 'border-gray-200'} ${t.highlight}`}
                placeholder="è©•èªå°‡é¡¯ç¤ºæ–¼æ­¤..."
              ></textarea>
              
              <div className="absolute bottom-4 right-6 text-xs text-gray-400 font-medium pointer-events-none bg-white/80 px-2 py-1 rounded backdrop-blur-sm no-print">
                 <span className="flex items-center gap-1"><AlignLeft className="w-3 h-3" /> å­—æ•¸: {currentStudent.generatedComment ? currentStudent.generatedComment.length : 0}</span>
              </div>
            </div>

            <div className="p-3 md:p-4 bg-white border-t border-gray-200 space-y-2 pb-6 md:pb-4 safe-area-bottom no-print">
               <button onClick={copyToClipboard} className={`w-full py-3 px-4 rounded-lg font-bold flex items-center justify-center gap-2 transition-all ${isCopied ? 'bg-green-600 text-white' : t.buttonPrimary} shadow-lg`}>
                  {isCopied ? <><CheckCircle2 className="w-5 h-5" /> å·²è¤‡è£½æˆåŠŸ</> : <><Copy className="w-5 h-5" /> è¤‡è£½è©•èª</>}
               </button>
            </div>
          </div>
        </div>
      </div>

      {/* Confirmation Modal */}
      {confirmConfig.show && (
        <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 p-4 no-print" onClick={() => setConfirmConfig({...confirmConfig, show: false})}>
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden animate-in fade-in zoom-in" onClick={e => e.stopPropagation()}>
            <div className="p-4 border-b border-gray-100 flex items-center gap-2 bg-yellow-50 text-yellow-800">
              <AlertTriangle className="w-5 h-5" />
              <h3 className="font-bold">{confirmConfig.title || 'ç¢ºèªå‹•ä½œ'}</h3>
            </div>
            <div className="p-6">
              <p className="text-gray-600 leading-relaxed whitespace-pre-line">{confirmConfig.message}</p>
            </div>
            <div className="p-4 bg-gray-50 flex justify-end gap-3">
              <button 
                onClick={() => setConfirmConfig({...confirmConfig, show: false})} 
                className="px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-lg transition-colors font-medium"
              >
                å–æ¶ˆ
              </button>
              <button 
                onClick={handleConfirmAction} 
                className="px-4 py-2 bg-red-600 text-white hover:bg-red-700 rounded-lg shadow-md transition-colors font-bold"
              >
                ç¢ºå®šåŸ·è¡Œ
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Other Modals (Custom, Help, Share) */}
      {showCustomModal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4 no-print">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden animate-in fade-in zoom-in">
            <div className="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50"><h3 className="font-bold">æ–°å¢è‡ªè¨‚èªå¥</h3><button onClick={()=>setShowCustomModal(false)}><X className="w-5 h-5 text-gray-400" /></button></div>
            <div className="p-6 space-y-4">
              <input type="text" value={newCustomLabel} onChange={e=>setNewCustomLabel(e.target.value)} placeholder="æ¨™ç±¤ (å¦‚: ç†±æ„›é«”è‚²)" className="w-full border rounded p-2" />
              <textarea value={newCustomText} onChange={e=>setNewCustomText(e.target.value)} placeholder="å®Œæ•´èªå¥..." className="w-full border rounded p-2 h-24" />
            </div>
            <div className="p-4 flex justify-end gap-2 bg-gray-50"><button onClick={()=>setShowCustomModal(false)} className="px-4 py-2 text-gray-600">å–æ¶ˆ</button><button onClick={saveCustomOption} className="px-4 py-2 bg-blue-600 text-white rounded">å„²å­˜</button></div>
          </div>
        </div>
      )}

      {showHelpModal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4 no-print" onClick={()=>setShowHelpModal(false)}>
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-3xl overflow-hidden animate-in fade-in zoom-in h-[85vh] flex flex-col" onClick={e=>e.stopPropagation()}>
            <div className="p-4 border-b flex justify-between items-center bg-blue-50">
              <h3 className="font-bold text-blue-800 flex items-center gap-2"><HelpCircle className="w-5 h-5"/> è©³ç´°ä½¿ç”¨èªªæ˜</h3>
              <button onClick={()=>setShowHelpModal(false)}><X className="w-5 h-5 text-gray-500" /></button>
            </div>
            
            <div className="flex-1 p-6 overflow-y-auto text-gray-700">
              <div className="space-y-8">
                
                {/* 1. å¿«é€Ÿå…¥é–€ */}
                <section>
                  <h4 className="text-xl font-bold text-blue-700 mb-4 flex items-center gap-2 pb-2 border-b border-blue-100">
                    <span className="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-base">1</span>
                    å¿«é€Ÿå…¥é–€æŒ‡å—
                  </h4>
                  <div className="grid md:grid-cols-2 gap-4">
                    <div className="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                      <h5 className="font-bold text-gray-800 mb-2">Step 1: é¸æ“‡å­¸ç”Ÿ</h5>
                      <p className="text-sm text-gray-600">å¾å·¦å´åå–®é»é¸åº§è™Ÿã€‚é è¨­æä¾› 1-40 è™Ÿã€‚</p>
                    </div>
                    <div className="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                      <h5 className="font-bold text-gray-800 mb-2">Step 2: è¼¸å…¥è³‡æ–™</h5>
                      <p className="text-sm text-gray-600">è¼¸å…¥å§“åã€æˆç¸¾ï¼ˆé¸å¡«ï¼‰ï¼Œä¸¦å‹¾é¸ä¸‹æ–¹çš„ç‰¹è³ªæ¨™ç±¤ã€‚</p>
                    </div>
                    <div className="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                      <h5 className="font-bold text-gray-800 mb-2">Step 3: ç”¢ç”Ÿè©•èª</h5>
                      <p className="text-sm text-gray-600">å³å´æœƒå³æ™‚é è¦½ã€‚é»æ“Šã€ŒAI æ™ºèƒ½æ½¤é£¾ã€è®“èªå¥æ›´é€šé †ã€‚</p>
                    </div>
                    <div className="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                      <h5 className="font-bold text-gray-800 mb-2">Step 4: å®Œæˆ</h5>
                      <p className="text-sm text-gray-600">ç¢ºèªç„¡èª¤å¾Œï¼Œé»æ“Šã€Œè¤‡è£½è©•èªã€è²¼åˆ°æ ¡å‹™ç³»çµ±ã€‚</p>
                    </div>
                  </div>
                </section>

                {/* 2. å¿…å‚™æŠ€å·§ */}
                <section>
                  <h4 className="text-xl font-bold text-purple-700 mb-4 flex items-center gap-2 pb-2 border-b border-purple-100">
                    <span className="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center text-base">2</span>
                    å¿…å‚™æŠ€å·§ (çœæ™‚ç§˜è¨£)
                  </h4>
                  <div className="space-y-4">
                    <div className="flex gap-4 items-start">
                      <div className="bg-indigo-50 p-2 rounded text-indigo-600"><FileSpreadsheet className="w-5 h-5" /></div>
                      <div>
                        <h5 className="font-bold text-gray-800">æ‰¹æ¬¡åŒ¯å…¥æˆç¸¾ (æ¨è–¦)</h5>
                        <p className="text-sm text-gray-600 mt-1">
                          ä¸æƒ³ä¸€ç­†ä¸€ç­†è¼¸å…¥ï¼Ÿè«‹å…ˆé»æ“Šå·¦ä¸‹è§’ã€Œ<span className="font-bold text-indigo-600">ä¸‹è¼‰ç¯„æœ¬</span>ã€ï¼Œç”¨ Excel å¡«å¥½å…¨ç­åå–®èˆ‡æˆç¸¾å¾Œï¼Œå†æŒ‰ã€ŒåŒ¯å…¥ CSVã€ï¼Œç¬é–“å®Œæˆå…¨ç­è³‡æ–™å»ºæª”ï¼
                        </p>
                      </div>
                    </div>
                    <div className="flex gap-4 items-start">
                      <div className="bg-green-50 p-2 rounded text-green-600"><Plus className="w-5 h-5" /></div>
                      <div>
                        <h5 className="font-bold text-gray-800">å»ºç«‹è‡ªè¨‚é‡‘å¥</h5>
                        <p className="text-sm text-gray-600 mt-1">
                          è¦ºå¾—é è¨­é¸é …ä¸å¤ ç”¨ï¼Ÿé»æ“Šå„åˆ†é¡æ¨™é¡Œæ—çš„ã€Œ<span className="font-bold text-gray-600">+ è‡ªè¨‚</span>ã€ï¼Œè¼¸å…¥æ‚¨çš„å°ˆå±¬è©•èªã€‚ç³»çµ±æœƒè‡ªå‹•å„²å­˜ï¼Œä»¥å¾Œéƒ½èƒ½é‡è¤‡ä½¿ç”¨ã€‚
                        </p>
                      </div>
                    </div>
                    <div className="flex gap-4 items-start">
                      <div className="bg-orange-50 p-2 rounded text-orange-600"><Wand2 className="w-5 h-5" /></div>
                      <div>
                        <h5 className="font-bold text-gray-800">AI èˆ‡æˆç¸¾é€£å‹•</h5>
                        <p className="text-sm text-gray-600 mt-1">
                          å¦‚æœæ‚¨æœ‰è¼¸å…¥æˆç¸¾ï¼ŒAI æ½¤é£¾æ™‚æœƒè‡ªå‹•åˆ¤æ–·ã€‚ä¾‹å¦‚æ•¸å­¸ 95 åˆ†ï¼ŒAI æœƒè‡ªå‹•åŠ å…¥ã€Œæ•¸ç†é‚è¼¯å„ªç•°ã€ï¼›è‹¥éœ€åŠªåŠ›ï¼Œå‰‡æœƒå¯«å‡ºå§”å©‰çš„é¼“å‹µèªå¥ã€‚
                        </p>
                      </div>
                    </div>
                    <div className="flex gap-4 items-start">
                      <div className="bg-amber-50 p-2 rounded text-amber-600"><DownloadCloud className="w-5 h-5" /></div>
                      <div>
                        <h5 className="font-bold text-gray-800">è·¨æ©ŸåŒæ­¥ / è¨­å®šå‚™ä»½</h5>
                        <p className="text-sm text-gray-600 mt-1">
                          åœ¨å­¸æ ¡åšå®Œæƒ³å¸¶å›å®¶ç¹¼çºŒï¼Ÿé»æ“Šå·¦ä¸‹è§’çš„ã€Œ<span className="font-bold text-amber-600">åŒ¯å‡ºå‚™ä»½</span>ã€ä¸‹è¼‰æª”æ¡ˆï¼Œå›å®¶å¾Œå†æŒ‰ã€ŒåŒ¯å…¥å‚™ä»½ã€ï¼Œæ‰€æœ‰è³‡æ–™èˆ‡è‡ªè¨‚é‡‘å¥å®Œç¾åŒæ­¥ï¼
                        </p>
                      </div>
                    </div>
                  </div>
                </section>

                {/* 3. è³‡æ–™å®‰å…¨èˆ‡å…¶ä»– */}
                <section>
                  <h4 className="text-xl font-bold text-green-700 mb-4 flex items-center gap-2 pb-2 border-b border-green-100">
                    <span className="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center text-base">3</span>
                    å¸¸è¦‹å•é¡Œ & è³‡æ–™å®‰å…¨
                  </h4>
                  <div className="bg-gray-50 rounded-xl p-5 space-y-4 text-sm">
                    <div>
                      <strong className="block text-gray-800 mb-1 flex items-center gap-2"><Save className="w-4 h-4"/> è³‡æ–™æœƒä¸è¦‹å—ï¼Ÿ</strong>
                      <p>ç³»çµ±æœƒè‡ªå‹•å°‡è³‡æ–™å­˜åœ¨æ‚¨çš„ç€è¦½å™¨ä¸­ (localStorage)ã€‚å³ä½¿é—œé–‰ç¶²é ï¼Œä¸‹æ¬¡æ‰“é–‹è³‡æ–™é€šå¸¸éƒ½é‚„åœ¨ã€‚ä½†ç‚ºäº†ä¿éšªèµ·è¦‹ï¼ŒæœŸæœ«å®Œæˆå¾Œå¼·çƒˆå»ºè­°é»æ“Šã€Œ<span className="font-bold text-green-600">åŒ¯å‡ºå‚™ä»½</span>ã€å°‡è³‡æ–™å‚™ä»½åˆ°é›»è…¦ä¸­ã€‚</p>
                    </div>
                    <div>
                      <strong className="block text-gray-800 mb-1 flex items-center gap-2"><Eraser className="w-4 h-4"/> å¦‚ä½•åˆªé™¤è³‡æ–™ï¼Ÿ</strong>
                      <p>è‹¥è¦åˆªé™¤å–®ä¸€ä½å­¸ç”Ÿï¼Œè«‹æŒ‰å§“åæ—çš„ç´…è‰²ã€Œæ¸…é™¤é‡ç½®ã€æŒ‰éˆ•ã€‚è‹¥è¦æ¸…ç©ºå…¨ç­é‡ä¾†ï¼Œè«‹æŒ‰å·¦ä¸‹è§’çš„ã€Œæ¸…ç©ºé‡ç½®ã€ã€‚</p>
                    </div>
                  </div>
                </section>

              </div>
            </div>
            
            <div className="p-4 bg-gray-50 border-t text-center">
              <button onClick={()=>setShowHelpModal(false)} className="px-8 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-bold shadow-md">æˆ‘ç­è§£äº†ï¼Œé–‹å§‹ä½¿ç”¨</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default CommentGenerator;
